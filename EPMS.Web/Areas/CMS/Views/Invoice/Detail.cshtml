@model EPMS.WebModels.ViewModels.Invoice.InvoiceViewModel
@{
    ViewBag.Title = EPMS.WebModels.Resources.CMS.Invoice.InvoiceTitle;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var direction = EPMS.WebModels.Resources.Shared.Common.TextDirection;
    var discount = Model.Quotation.QuotationDiscount;
    string date = Model.Quotation.RecCreatedDate.ToString();
    string[] str = date.Split(' ');
    date = str[0];
    var Role = Session["RoleName"].ToString();
}

<!-- Navigation Bar -->
<div class="breadcrumb-container">
    <ul class="xbreadcrumbs">
        <li>
            <a href="~/Dashboard/Index">
                <i class="icon-photon home"></i>
            </a>
        </li>
        <li>
            <a href="~/CMS/Invoice/Index">
                @EPMS.WebModels.Resources.CMS.Invoice.InvoiceTitle
            </a>
        </li>
        <li>
            @ViewBag.Title
        </li>
    </ul>
</div>
<!-- Page heading -->
<header>
    <i class="icon-big-notepad"></i>
    <h2><small>@ViewBag.Title</small></h2>
</header>

<!--Notifications begin-->
@Html.Partial("_Alert")
<!--Notifications end-->
<!-- Page heading ends -->
@using (Html.BeginForm("Detail", "Invoice", FormMethod.Post, new { @class = "form-horizontal", @id = "invoiceForm", role = "form", enctype = "multipart/form-data" }))
{
    <div class="container-fluid">
        @Html.HiddenFor(model => model.Invoice.InvoiceId, new { @id = "invoiceId" })
        @Html.HiddenFor(model => model.Invoice.QuotationId)

        <div class="control-group row-fluid">

            <div class="form-legend centTitle">
                @EPMS.WebModels.Resources.CMS.Invoice.InvoiceTitle
            </div>
            <div class="invoice-info">

                <div class="invoice-name">
                    @(direction == "ltr" ? Model.CompanyProfile.CompanyNameE : Model.CompanyProfile.CompanyNameA)
                </div>
                <div class="controls">
                    <a href="javascript:print()" rel="tooltip" title="" data-original-title="Print statistics" class="print"><i class="icon-print"></i> @EPMS.WebModels.Resources.CMS.Invoice.Print</a>
                </div>
                @if (!(string.IsNullOrEmpty(ViewBag.LogoPath)))
                {
                    <img class="employeeImg" src='@Url.Content(ViewBag.LogoPath)' alt="user" />
                }
                else
                {
                    <img class="employeeImg" alt="Logo" />
                }

                <div class="control-group row-fluid">

                    <div class="span3">
                        <div class="invoice-from">
                            <span>@(direction == "ltr" ? ViewBag.EmployeeNameE : ViewBag.EmployeeNameA)</span>
                            <strong>
                                @(direction == "ltr" ? Model.CompanyProfile.CompanyNameE : Model.CompanyProfile.CompanyNameA)
                            </strong>
                            <address>
                                @Model.CompanyProfile.CompanyAddressE <br />
                                <abbr title="Phone">@EPMS.WebModels.Resources.CMS.Invoice.Phone:</abbr> @Model.CompanyProfile.CompanyNumber <br>
                                <abbr title="Website">@EPMS.WebModels.Resources.CMS.Invoice.Website:</abbr> @Model.CompanyProfile.CompanyWebsite <br>
                                <abbr title="invoiceMail">@EPMS.WebModels.Resources.CMS.Invoice.Email:</abbr> @Model.CompanyProfile.CompanyEmail <br>
                            </address>
                        </div>
                    </div>
                    <div class="span3">
                        <div class="invoice-to">
                            <span>@EPMS.WebModels.Resources.CMS.Quotation.ClientName</span>
                            <strong>@(direction == "ltr" ? Model.Quotation.ClientNameEn : Model.Quotation.ClientNameAr)</strong>
                            <address>
                                @EPMS.WebModels.Resources.CMS.Quotation.StreetAddress
                                @Model.Quotation.CustomerAddress <br>
                                <abbr title="Phone">@EPMS.WebModels.Resources.CMS.Quotation.Phone:</abbr> @Model.Quotation.CustomerPhone <br>
                                <abbr title="Fax">@EPMS.WebModels.Resources.CMS.Quotation.Email:</abbr> @Model.Quotation.CustomerEmail
                            </address>
                        </div>
                    </div>
                    <div class="span6">
                        <div class="invoice-infos">
                            <table>
                                <tbody>
                                    <tr>
                                        <th>@EPMS.WebModels.Resources.CMS.Invoice.Date:</th>
                                        <td>@date</td>
                                    </tr>
                                    <tr>
                                        <th>@EPMS.WebModels.Resources.CMS.Invoice.QuotationNumber:</th>
                                        <td>@Model.Quotation.SerialNumber</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>

                <div class="control-group row-fluid">
                    <div class="span3">
                        <label class="control-label" for="GreetingEn">@EPMS.WebModels.Resources.CMS.Quotation.Greetings</label>
                    </div>
                    <div class="span9">
                        <div class="controls">
                            @if (direction == "ltr")
                            {
                                @Html.TextBoxFor(model => model.Quotation.GreetingsEn, new { @id = "GreetingEn", @class = "", @readonly = true })
                            }
                            else
                            {
                                @Html.TextBoxFor(model => model.Quotation.GreetingsAr, new { @id = "GreetingAr", @class = "", @readonly = true })
                            }
                        </div>
                    </div>
                </div>

                <div class="row-fluid" id="ress">

                    <div class="span12">
                        <table class="table table-striped table-responsive ">
                            <thead class="">
                                <tr>
                                    <th style="width:70%">@EPMS.WebModels.Resources.CMS.Quotation.ItemDetails</th>
                                    <th>@EPMS.WebModels.Resources.CMS.Quotation.Quantity</th>
                                    <th>@EPMS.WebModels.Resources.CMS.Quotation.UnitPrice</th>
                                    <th>@EPMS.WebModels.Resources.CMS.Quotation.Total</th>
                                </tr>
                            </thead>
                            <tbody class="qouteAdd">
                                @foreach (var itemDetail in Model.Quotation.QuotationItemDetails)
                                {
                                    <tr>
                                        <td>
                                            @itemDetail.ItemDetails
                                        </td>
                                        <td class="">
                                            @itemDetail.ItemQuantity
                                        </td>
                                        <td class="">
                                            @itemDetail.UnitPrice
                                        </td>
                                        <td class="total">
                                            @itemDetail.TotalPrice
                                        </td>
                                    </tr>
                                }
                                <tr class="invoiceCal">
                                    <td colspan="2"></td>
                                    <td class="sub">
                                        @EPMS.WebModels.Resources.CMS.Quotation.Subtotal :
                                    </td>
                                    <td id="subtotal">
                                        @Model.Quotation.SubTotal
                                    </td>
                                </tr>
                                <tr class="invoiceCal">
                                    <td colspan="2"></td>
                                    <td class="disc">
                                        @EPMS.WebModels.Resources.CMS.Quotation.Discount :
                                    </td>
                                    <td id="Discount">
                                        @discount
                                    </td>
                                </tr>
                                <tr class="invoiceCal">
                                    <td colspan="2"></td>
                                    <td class="gTotal">
                                        @EPMS.WebModels.Resources.CMS.Quotation.GrandTotal :
                                    </td>
                                    <td id="GrandTotal">
                                        @Model.Quotation.GrandTotal
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="control-group row-fluid">
                        <div class="span3">
                            <label class="control-label" for="inWord">@EPMS.WebModels.Resources.CMS.Quotation.InWords</label>
                        </div>
                        <div class="span9">
                            <div class="controls">
                                <input id="inWord" type="text" name="numbers" value="0" class="newLine" disabled />
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info alert-block">
                        <i class="icon-alert icon-alert-info"></i>
                        <strong><a>@EPMS.WebModels.Resources.CMS.Quotation.InstallmentPlan</a></strong>
                    </div>

                    <div class="control-group row-fluid">
                        <div class="span3">
                            <label class="control-label" for="Installment1">@EPMS.WebModels.Resources.CMS.Quotation.FirstInstallment<a href="javascript:;" class="bootstrap-tooltip" data-placement="top" data-original-title="0-100"><i class="icon-photon info-circle"></i></a></label>
                        </div>
                        <div class="span9">
                            <div class="controls">
                                @Html.TextBoxFor(model => model.Quotation.FirstInstallement, new { @id = "Installment1", @class = "installer", @readonly = true })
                            </div>
                        </div>
                    </div>
                    <div class="control-group row-fluid">
                        <div class="span3">
                            <label class="control-label" for="DueAt1">@EPMS.WebModels.Resources.CMS.Quotation.DueAt<a href="javascript:;" class="bootstrap-tooltip" data-placement="top" data-original-title="0-100"><i class="icon-photon info-circle"></i></a></label>
                        </div>
                        <div class="span4 span-inset">
                            <div class="progress progress-info">
                                <div class="bar" style="width:@Model.Quotation.FirstInsDueAtCompletion%">@Model.Quotation.FirstInsDueAtCompletion%</div>
                            </div>
                        </div>
                        @if (@Model.Quotation.FirstInstallement != 0)
                        {
                            <div class="span3">
                            <label class="control-label">
                                @if (@Model.Quotation.FirstInstallmentStatus == "Paid")
                                {
                                    <a href="/CMS/Receipt/Detail/@Model.FirstReceiptId" id="installmentLabel1">@Model.Quotation.FirstInstallmentStatus</a>
                                }
                                else
                                {
                                    <a id="installmentLabel1">@Model.Quotation.FirstInstallmentStatus</a>
                                }
                            </label>
                        </div>
                        if (!@Model.Quotation.IsFirstInstallmentStatus)
                        {
                            <div class="span2">
                                @if (Role == "Customer")
                                {
                                    <label class="control-label"><a class="btn" id="generateReceipt1" href="~/CMS/Payment/Index/@Model.Invoice.InvoiceId?ins=1">Pay</a></label>
                                }
                                else
                                {
                                    <label class="control-label"><button id="generateReceipt1" onclick="CreateReceipt(1)">Generate Receipt</button></label>
                                }
                            </div>
                        }
                        }
                    </div>
                    <div class="control-group row-fluid">
                        <div class="span3">
                            <label class="control-label" for="Installment2">@EPMS.WebModels.Resources.CMS.Quotation.SecondInstallment<a href="javascript:;" class="bootstrap-tooltip" data-placement="top" data-original-title="0-100"><i class="icon-photon info-circle"></i></a></label>
                        </div>
                        <div class="span9">
                            <div class="controls">
                                @Html.TextBoxFor(model => model.Quotation.SecondInstallment, new { @id = "Installment2", @class = "installer", @readonly = true })
                            </div>
                        </div>
                    </div>
                    <div class="control-group row-fluid">
                        <div class="span3">
                            <label class="control-label" for="DueAt2">@EPMS.WebModels.Resources.CMS.Quotation.DueAt<a href="javascript:;" class="bootstrap-tooltip" data-placement="top" data-original-title="0-100"><i class="icon-photon info-circle"></i></a></label>
                        </div>
                        <div class="span4 span-inset">
                            <div class="progress progress-info">
                                <div class="bar" style="width:@Model.Quotation.SecondInsDueAtCompletion%">@Model.Quotation.SecondInsDueAtCompletion%</div>
                            </div>
                        </div>
                        @if (@Model.Quotation.SecondInstallment != 0)
                        {
                            <div class="span3">
                            <label class="control-label">
                                @if (@Model.Quotation.SecondInstallmentStatus == "Paid")
                                {
                                    <a href="/CMS/Receipt/Detail/@Model.SecondReceiptId" id="installmentLabel2">@Model.Quotation.SecondInstallmentStatus</a>
                                }
                                else
                                {
                                    <a id="installmentLabel2">@Model.Quotation.SecondInstallmentStatus</a>
                                }
                            </label>
                        </div>
                        if (!@Model.Quotation.IsSecondInstallmentStatus)
                        {
                            <div class="span2">
                                @if (Role == "Customer")
                                {
                                    <label class="control-label"><a class="btn" id="PayInstallment2" href="~/CMS/Payment/Index/@Model.Invoice.InvoiceId?ins=2">Pay</a></label>
                                }
                                else
                                {
                                    <label class="control-label"><button id="generateReceipt2" onclick="CreateReceipt(2)">Generate Receipt</button></label>
                                }
                            </div>
                        }
                        }
                    </div>
                    <div class="control-group row-fluid">
                        <div class="span3">
                            <label class="control-label" for="Installment3">@EPMS.WebModels.Resources.CMS.Quotation.ThirdInstallment<a href="javascript:;" class="bootstrap-tooltip" data-placement="top" data-original-title="0-100"><i class="icon-photon info-circle"></i></a></label>
                        </div>
                        <div class="span9">
                            <div class="controls">
                                @Html.TextBoxFor(model => model.Quotation.ThirdInstallment, new { @id = "Installment3", @class = "installer", @readonly = true })
                            </div>
                        </div>
                    </div>
                    <div class="control-group row-fluid">
                        <div class="span3">
                            <label class="control-label" for="DueAt3">@EPMS.WebModels.Resources.CMS.Quotation.DueAt<a href="javascript:;" class="bootstrap-tooltip" data-placement="top" data-original-title="0-100"><i class="icon-photon info-circle"></i></a></label>
                        </div>
                        <div class="span4 span-inset">
                            <div class="progress progress-info">
                                <div class="bar" style="width:@Model.Quotation.ThirdInsDueAtCompletion%">@Model.Quotation.ThirdInsDueAtCompletion%</div>
                            </div>
                        </div>
                        @if (@Model.Quotation.ThirdInstallment != 0)
                        {
                            <div class="span3">
                            <label class="control-label">
                                @if (@Model.Quotation.ThirdInstallmentStatus == "Paid")
                                {
                                    <a href="/CMS/Receipt/Detail/@Model.ThirdReceiptId" id="installmentLabel3">@Model.Quotation.ThirdInstallmentStatus</a>
                                }
                                else
                                {
                                    <a id="installmentLabel3">@Model.Quotation.ThirdInstallmentStatus</a>
                                }
                            </label>
                        </div>
                        if (!@Model.Quotation.IsThirdInstallmentStatus)
                        {
                            <div class="span2">
                                @if (Role == "Customer")
                                {
                                    <label class="control-label"><a class="btn" id="PayInstallment3" href="~/CMS/Payment/Index/@Model.Invoice.InvoiceId?ins=3">Pay</a></label>
                                }
                                else
                                {
                                    <label class="control-label"><button id="generateReceipt3" onclick="CreateReceipt(3)">Generate Receipt</button></label>
                                }
                            </div>
                        }
                        }
                    </div>
                    <div class="control-group row-fluid">
                        <div class="span3">
                            <label class="control-label" for="Installment4">@EPMS.WebModels.Resources.CMS.Quotation.FourthInstallment<a href="javascript:;" class="bootstrap-tooltip" data-placement="top" data-original-title="0-100"><i class="icon-photon info-circle"></i></a></label>
                        </div>
                        <div class="span9">
                            <div class="controls">
                                @Html.TextBoxFor(model => model.Quotation.FourthInstallment, new { @id = "Installment4", @class = "installer", @readonly = true })
                            </div>
                        </div>
                    </div>
                    <div class="control-group row-fluid">
                        <div class="span3">
                            <label class="control-label" for="DueAt4">@EPMS.WebModels.Resources.CMS.Quotation.DueAt<a href="javascript:;" class="bootstrap-tooltip" data-placement="top" data-original-title="0-100"><i class="icon-photon info-circle"></i></a></label>
                        </div>
                        <div class="span4 span-inset">
                            <div class="progress progress-info">
                                <div class="bar" style="width:@Model.Quotation.FourthInsDueAtCompletion%">@Model.Quotation.FourthInsDueAtCompletion%</div>
                            </div>
                        </div>
                        @if (@Model.Quotation.FourthInstallment != 0)
                        {
                            <div class="span3">
                            <label class="control-label">
                                @if (@Model.Quotation.FourthInstallmentStatus == "Paid")
                                {
                                    <a href="/CMS/Receipt/Detail/@Model.FourthReceiptId" id="installmentLabel4">@Model.Quotation.FourthInstallmentStatus</a>
                                }
                                else
                                {
                                    <a id="installmentLabel4">@Model.Quotation.FourthInstallmentStatus</a>
                                }
                            </label>
                        </div>
                        if (!@Model.Quotation.IsFourthInstallmentStatus)
                        {
                            <div class="span2">
                                @if (Role == "Customer")
                                {
                                    <label class="control-label"><a class="btn" id="PayInstallment4" href="~/CMS/Payment/Index/@Model.Invoice.InvoiceId?ins=4">Pay</a></label>
                                }
                                else
                                {
                                    <label class="control-label"><button id="generateReceipt4" onclick="CreateReceipt(4)">Generate Receipt</button></label>
                                }
                            </div>
                        }
                        }
                    </div>
                    <div class="control-group row-fluid">
                        <div class="span3">
                            <label class="control-label" for="ExtraInformationEn">@EPMS.WebModels.Resources.CMS.Quotation.Notes</label>
                        </div>
                        <div class="span9">
                            <div class="controls">
                                @if (direction == "ltr")
                                {
                                    @Html.TextBoxFor(model => model.Quotation.NotesEn, new { @id = "NotesEn", @class = "", @readonly = true })
                                }
                                else
                                {
                                    @Html.TextBoxFor(model => model.Quotation.NotesAr, new { @id = "NotesAr", @class = "", @readonly = true })
                                }
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
}

<script type="text/javascript" src="~/Scripts/plugins/jquery.nToWord.js"></script>
<script>
    siteUrl = $('#siteURL').val();
    var direction = '@direction';
    $(document).ready(function () {
        debugger;
        if (direction == "ltr") {
            jQuery('#inWord').val($.nToWord({ number: parseInt($('#GrandTotal').text()), language: "en" }));
        } else {
            jQuery('#inWord').val($.nToWord({ number: parseInt($('#GrandTotal').text()), language: "ar" }));
        }
        if (direction == 'ltr') {
            var descpE = $("#NotesEn").val();
            var regex = /(<([^>]+)>)/ig;
            var result = descpE.replace(regex, "");
            $("#NotesEn").val(result);
        } else {
            var descpA = $("#NotesAr");
            var regex = /(<([^>]+)>)/ig;
            var result = descpA.replace(regex, "");
            $("#NotesAr").val(result);
        }

        //function discount() {
        //    var subtotal = parseInt($('#subtotal').text());
        //    var Discount = parseInt($('#Discount').text());
        //    var grand = subtotal - (subtotal * (Discount / 100));
        //    $('#GrandTotal').text(grand);
        //    $('#inWord').val($.nToWord({ number: grand, language: "en" }));
        //}
    });

    function CreateReceipt(id, e) {
        debugger;
        event.preventDefault();
        var installmentId = id;
        var invoiceId = $('#invoiceId').val();
        var amountPaid = $('#Installment' + id).val();

        var dataToPost = {
            installmentId: installmentId,
            invoiceId: invoiceId,
            amountPaid: amountPaid,
        };
        var url = "/CMS/Invoice/CreateReceipt";
        $.ajax({
            url: url,
            type: 'POST',
            dataType: "json",
            data: dataToPost,
            success: function (data) {
                $('#installmentLabel' + id).text("Paid");
                $('#generateReceipt' + id).hide();
                $('#installmentLabel' + id).attr("href", "/CMS/Receipt/Detail/" + data);
            },
            error: function (e) {
                alert('Error=' + e.toString());
            }
        });
    }

</script>