@model EPMS.WebModels.ViewModels.Orders.OrdersListViewModel

@{
    ViewBag.Title = EPMS.WebModels.Resources.CMS.Order.PTIndex;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var direction = EPMS.WebModels.Resources.Shared.Common.TextDirection;
    var userRole = (string)Session["RoleName"];
}

<!-- Navigation Bar -->
<div class="breadcrumb-container">
    <ul class="xbreadcrumbs">
        <li>
            <a href="~/Dashboard/Index">
                <i class="icon-photon home"></i>
            </a>
        </li>
        <li>
            @ViewBag.Title
        </li>
    </ul>
</div>
<!-- Page heading -->
<header>
    <i class="icon-big-notepad"></i>
    <h2><small>@ViewBag.Title</small></h2>
    @if (userRole == "Customer")
    {
        <h3><small><a href="~/CMS/Orders/Create">@EPMS.WebModels.Resources.CMS.Order.CreateNew</a></small></h3>
    }
</header>
<!--Notifications begin-->
@Html.Partial("_Alert")
<!--Notifications end-->
<!-- Page heading ends -->

<form class="form-horizontal">
    @Html.HiddenFor(model => model.SearchRequest.SearchString, new { id = "searchString" });
    <div class="container-fluid">
        <!--Sortable Responsive Media Table begin-->
        <div class="row-fluid">
            <div class="span12">
                <table class="table table-striped table-responsive" id="OrdersListTable">
                    <thead class="">
                        <tr>
                            <th>@EPMS.WebModels.Resources.Shared.Common.Serial</th>
                            <th>@EPMS.WebModels.Resources.CMS.Order.OrderNo</th>
                            <th>@EPMS.WebModels.Resources.CMS.Order.ClientName</th>
                            <th>@EPMS.WebModels.Resources.CMS.Order.Quotation</th>
                            <th>@EPMS.WebModels.Resources.CMS.Order.Invoice</th>
                            <th>@EPMS.WebModels.Resources.CMS.Order.Reciept</th>
                            <th>@EPMS.WebModels.Resources.CMS.Order.Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</form>

<script type="text/javascript">
    $(document).ready(function () {
        var siteUrl = $('#siteURL').val();
        var dir = '@direction';
        var oTable = $('#OrdersListTable').dataTable({
            "sPaginationType": "bootstrap",
            "bProcessing": true,
            "bServerSide": true,
            "sAjaxSource": siteUrl + "/CMS/Orders/Index",
            "sServerMethod": "POST",
            "aoColumns": [
                {
                    "aTargets": [0],
                    "sDefaultContent": "",
                    "bVisible": true,
                    "bSortable": false
                },
                {
                    "aTargets": [1],
                    "sDefaultContent": "No Data",
                    "mRender": function (data, type, full) {
                        var element = "";
                        var val = full["OrderNo"];
                        var quotationId = full["QuotationId"];
                        element = '<a href="Create/' + quotationId + '">' + val + '</a>';
                        return element;
                    },
                    "bSortable": true
                },
                {
                    "aTargets": [2],
                    "sDefaultContent": "No Data",
                    "mRender": function (data, type, full) {
                        var element = "";
                        if ('@direction' == "ltr") {
                            element = full["CustomerNameE"];
                        }
                        if ('@direction' == "rtl") {
                            element = full["CustomerNameA"];
                        }
                        return element;
                    }
                },
                {
                    "aTargets": [3],
                    "sDefaultContent": "No Data",
                    "mRender": function (data, type, full) {
                        var element = "No Data";
                        var val = full["QuotationNumber"];
                        var quotationId = full["QuotationId"];
                        if (quotationId != 0) {
                            if ('@userRole' == "Admin" && val != 0) {
                                element = '<a href="' + siteUrl + '/CMS/Quotation/Create/' + quotationId + '">' + val + '</a>';
                            }
                            if ('@userRole' == "Customer" && val != 0) {
                                element = '<a href="' + siteUrl + '/CMS/Quotation/Detail/' + quotationId + '">' + val + '</a>';
                            }
                        }
                        return element;
                    },
                    "bSortable": true 
                },
                {
                    "aTargets": [4],
                    "sDefaultContent": "No Data",
                    "mRender": function (data, type, full) {
                        var element = "No Data";
                        var val = full["InvoiceNumber"];
                        var invoiceId = full["InvoiceId"];
                        if (invoiceId != 0) {
                            element = '<a href="' + siteUrl + '/CMS/Invoice/Detail/' + invoiceId + '">' + val + '</a>';
                        }
                        return element;
                    },
                    "bSortable": false
                },
                {
                    "aTargets": [5],
                    "sDefaultContent": "No Data",
                    "mRender": function (data, type, full) {
                        var receipts = full["Receipts"];
                        var element = "No Data";
                        if (receipts != null) {
                            if (receipts.length > 0) {
                                element = "";
                                for (var i = 0; i < receipts.length; i++) {
                                    if (i != 0)
                                        element += " / ";
                                    element += '<a href="' + siteUrl + '/CMS/Receipt/Detail/' + receipts[i].ReceiptId + '">' + (i+1) + '</a>';
                                }
                            }
                        }
                        return element;
                    },
                    "bSortable": false
                },
                {
                    "aTargets": [6],
                    "sDefaultContent": "No Data",
                    "mRender": function (data, type, full) {
                        var value = "";
                        if (full["OrderStatus"] == 1) {
                            value = '@EPMS.WebModels.Resources.CMS.Order.Pending';
                        } else if (full["OrderStatus"] == 2) {
                            value = '@EPMS.WebModels.Resources.CMS.Order.OnGoing';
                        } else if (full["OrderStatus"] == 3) {
                            value = '@EPMS.WebModels.Resources.CMS.Order.Canceled';
                        }
                        else if (full["OrderStatus"] == 4) {
                            value = '@EPMS.WebModels.Resources.CMS.Order.Completed';
                        }
                        return value;
                    }
                }
            ],
            "fnServerParams": function (aoData) {
                aoData.push({ "name": "search", "value": $('input').val() });
            },
            "oLanguage": {
                "sProcessing": "Fetching record(s)",
                //"sProcessing": "<img alt=\"Unread\" id=\"ajaxLoadImg\" src=\"/Images\/Gallery\/ajax_loader_red_512.gif\" />",
                "sInfoEmpty": "No matching record(s) found",
                "sEmptyTable": "No record(s) found",
            },
            "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                var oSettings = oTable.fnSettings();
                $("td:first", nRow).html(oSettings._iDisplayStart + iDisplayIndex + 1);
                return nRow;
            },
        });
        $(".dataTables_length select").select2({
            dropdownCssClass: 'noSearch'
        });
        $(".dataTables_filter input").unbind()
            .bind("input", function (e) {
                // Bind our desired behavior
                if (this.value.length >= 3 || e.keyCode == 13) {
                    $("#searchString").val(this.value);
                    oTable.fnDraw();
                }
                if (this.value == "") {
                    $("#searchString").val(this.value);
                    oTable.fnDraw();
                }
                return;
            });
    });
</script>