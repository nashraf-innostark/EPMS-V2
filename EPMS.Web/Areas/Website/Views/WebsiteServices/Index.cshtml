@model EPMS.WebModels.ViewModels.Website.Services.ServicesListViewModel
@{
    ViewBag.Title = "Website Services's Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string direction = EPMS.WebModels.Resources.Shared.Common.TextDirection;
    string[] userPermissionsSet = (string[])HttpContext.Current.Session["UserPermissionSet"];
    int i = 0;
    int j = 0;
}
<div class="main-content withPanel">
    <div class="panel">
        <div class="panel-content filler">
            <div class="panel-logo"></div>
            <div class="panel-header">
                <h1><small>Services</small></h1>
            </div>
            <div class="panel-search container-fluid">
                <form class="form-horizontal" action="javascript:;">
                    <input id="panelSearch" placeholder="Search" type="text" name="panelSearch">
                    <button class="btn btn-search"></button>
                </form>
            </div>
            <div class="sidebarMenuHolder">
                <div class="JStree">
                    <div class="Jstree_shadow_top"></div>
                    <div id="jstree"></div>
                    <div class="Jstree_shadow_bottom"></div>
                </div>
            </div>
        </div>
        <div class="panel-slider">
            <div class="panel-slider-center">
                <div class="panel-slider-arrow"></div>
            </div>
        </div>
    </div>
    <div class="breadcrumb-container">
        <ul class="xbreadcrumbs">
            <li>
                <a href="~/Dashboard/Index">
                    <i class="icon-photon home"></i>
                </a>
            </li>
            <li>
                Website Services
            </li>
        </ul>
    </div>
    <header>
        <i class="icon-big-notepad"></i>
        <h2><small>Website Services</small></h2>
    </header>
    @Html.Partial("_Alert")
    <form class="form-horizontal" id="validation_form">
        <div class="container-fluid">
            <div class="control-group row-fluid span-inset">
                <ul class="nav nav-tabs" id="myTab">
                    <li class="active"><a data-toggle="tab" href="#tab-example1">Services</a></li>
                    <li class=""><a data-toggle="tab" href="#tab-example2">Sections</a></li>
                </ul>
                <div class="tab-content">
                    <div id="tab-example1" class="tab-pane fade active in">
                        @if (userPermissionsSet.Contains("ServiceCreate"))
                        {
                            <h3><small><a href="~/Website/WebsiteServices/Create">Add New Service</a></small></h3>
                        }
                        <div class="container-fluid">
                            <table class="table table-striped table-responsive" id="tableSortableResMed">
                                <thead class="cf sorthead">
                                    <tr>
                                        <th class="center">Serial</th>
                                        <th class="center">Name</th>
                                        <th class="center">Description</th>
                                        <th class="center">Number of Sections</th>
                                        <th class="center">Number of Sub-Sections</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var service in Model.Services)
                                    {
                                        var id = service.ServiceId + "_tableServices";
                                        <tr class="gradeX" id="@id">
                                            <td class="center">@(i += 1)</td>
                                            @*<td class="center">@(direction == "ltr" ? service.ServiceNameEn : service.ServiceNameAr)</td>*@
                                            @if (direction == "ltr")
                                            {
                                                <td class="center"><a href="~/Website/WebsiteServices/Create/@service.ServiceId">@service.ServiceNameEn</a></td>
                                            }
                                            else
                                            {
                                                <td class="center"><a href="~/Website/WebsiteServices/Create/@service.ServiceId">@service.ServiceNameAr</a></td>
                                            }
                                            <td class="center @service.ServiceId"></td>
                                            <script>
                                                var descp = '@Html.Raw((direction == "ltr" ? service.DescriptionEn : service.DescriptionAr))';
                                                var regex = /(<([^>]+)>)/ig;
                                                var result = descp.replace(regex, "");
                                                $("." + '@service.ServiceId').text(result);
                                            </script>
                                            <td class="center">@service.NoofSections</td>
                                            <td class="center">-</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="tab-example2" class="tab-pane fade">
                        @if (userPermissionsSet.Contains("ServiceCreate"))
                        {
                            <h3><small><a href="~/Website/WebsiteServices/Create">Add New Section</a></small></h3>
                        }
                        <div class="container-fluid">
                            <div class="row-fluid">
                                <div class="span12">
                                    <table class="table table-striped table-responsive" id="tableSortableResMed2">
                                        <thead class="cf sorthead">
                                            <tr>
                                                <th class="center">Serial</th>
                                                <th class="center">Parent Service</th>
                                                <th class="center">Parent Section</th>
                                                <th class="center">Name</th>
                                                <th class="center">Description</th>
                                                <th class="center">Number of Sub-Sections</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var sect in Model.Sections)
                                            {
                                                var id = sect.ServiceId + "_tableSections";
                                                <tr class="gradeX" id="@id">
                                                    <td>@(j += 1)</td>
                                                    <td class="center">@(direction == "ltr" ? sect.ParentServiceEn : sect.ParentServiceAr)</td>
                                                    <td class="center">
                                                        @if (sect.ParentService != null)
                                                        {
                                                            var k = 0;
                                                            var parent = sect.ParentService;
                                                            while (parent != null)
                                                            {
                                                                if (k != 0)
                                                                {
                                                                    @: >
                                                                }
                                                                k++;
                                                                if (direction == "ltr")
                                                                {
                                                                    <a href="~/Website/WebsiteServices/Create/@parent.ServiceId">@parent.ServiceNameEn</a>
                                                                }
                                                                else
                                                                {
                                                                    <a href="~/Website/WebsiteServices/Create/@parent.ServiceId">@parent.ServiceNameAr</a>
                                                                }
                                                                parent = parent.ParentService;
                                                            }
                                                        }
                                                    </td>
                                                    @*<td class="center">@(direction == "ltr" ? sect.ServiceNameEn : sect.ServiceNameAr)</td>*@
                                                    @if (direction == "ltr")
                                                    {
                                                        <td class="center"><a href="~/Website/WebsiteServices/Create/@sect.ServiceId">@sect.ServiceNameEn</a></td>
                                                    }
                                                    else
                                                    {
                                                        <td class="center"><a href="~/Website/WebsiteServices/Create/@sect.ServiceId">@sect.ServiceNameAr</a></td>
                                                    }
                                                    <td class="center @sect.ServiceId">@(direction == "ltr" ? sect.DescriptionEn : sect.DescriptionAr)</td>
                                                    <script>
                                                        var descp = '@Html.Raw((direction == "ltr" ? sect.DescriptionEn : sect.DescriptionAr))';
                                                        var regex = /(<([^>]+)>)/ig;
                                                        var result = descp.replace(regex, "");
                                                        $("." + '@sect.ServiceId').text(result);
                                                    </script>
                                                    <td>-</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- end container -->
    </form>
</div>
<link href="~/Content/CSS/jsTreeCheckbox/style.css" rel="stylesheet" />
<script type="text/javascript">
    var websiteServicesList = '@Html.Raw(Json.Encode(Model.Services))';
    var websiteServices = JSON.parse(websiteServicesList);
    var parsedSectionsList = '@Html.Raw(Json.Encode(Model.Sections))';
    var parsedSections = JSON.parse(parsedSectionsList);
    var divId;
    $(document).ready(function () {
        divId = "jstree";
        $("#layoutMainContent").removeClass("main-content");
        $('.panel, .main-content').toggleClass('retracted');
        var list = '@Html.Raw(ViewBag.JsTree)';
        var tree = JSON.parse(list);
        $("#" + divId).jstree({
            'core': {
                'check_callback': true,
                'data': tree
            },
            "plugins": ["themes", "json_data", "ui"],
        }).on('loaded.jstree', function () {
            $("#" + divId).jstree('open_all');
        });
        setTimeout(function () {
            subItemsOfServices();
            subItemsOfSections();
        }, 500);

    });
    function subItemsOfServices() {
        $.each(websiteServices, function (key, value) {
            var serviceId = value.ServiceId;
            var parent = $('#' + divId).find("[id='" + serviceId + "']");
            //var parent = $("ul").find("#" + serviceId).parent();
            var childs = $(parent).find("li").length;
            $("#" + serviceId + "_tableServices td:eq( 4 )").text(childs);
        });
    }
    function subItemsOfSections() {
        $.each(parsedSections, function (key, value) {
            var serviceId = value.ServiceId;
            var parent = $('#jstree').find("[id='" + serviceId + "']");
            var childs = $(parent).find("li").length;
            $("#" + serviceId + "_tableSections td:eq( 5 )").text(childs);
        });
    }
</script>