@using System.Configuration
@model EPMS.Web.ViewModels.Employee.EmployeeDetailViewModel
@{
    ViewBag.Title = Model.EmployeeViewModel.PageTitle;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Navigation Bar -->
<div class="breadcrumb-container">
    <ul class="xbreadcrumbs">
        <li>
            <a href="dashboard-En.html">
                <i class="icon-photon home"></i>
            </a>
        </li>
        @if (Roles.IsUserInRole("Admin"))
        {
            <li>
                <a href="~/HR/Employee/Index">
                    Employees
                </a>
            </li>
        }
        @if (Model.EmployeeViewModel.Employee != null)
        {
            <li>
                <a href="">
                    @Model.EmployeeViewModel.EmployeeName
                </a>
            </li>
        }
        else
        {
            <li>
                <a href="">
                    Add New Employee
                </a>
            </li>
        }
    </ul>
</div>
<!-- Page heading -->
<header>
    <i class="icon-big-notepad"></i>
    <h2><small>@Model.EmployeeViewModel.EmployeeName</small></h2>
    @if (Model.EmployeeViewModel.Employee != null)
    {
        if (Model.EmployeeViewModel.Employee.EmployeeId > 0)
        {
            <img class="employeeImg" src='@Model.EmployeeViewModel.ImagePath' alt="Employee" />
        }
    }
</header>

<!--Notifications begin-->
@Html.Partial("_Alert")
<!--Notifications end-->
<!-- Page heading ends -->
@using (Html.BeginForm("Create", "Employee", FormMethod.Post, new { @class = "form-horizontal", @id = "AddEditEmployeeForm", role = "form", enctype = "multipart/form-data" }))
{
    <div class="container-fluid">
        @Html.AntiForgeryToken()

        @Html.HiddenFor(model => model.EmployeeViewModel.Employee.EmployeeId)
        @Html.HiddenFor(model => model.EmployeeViewModel.Employee.EmployeeImagePath, new { @id = "EmployeeImage" })
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label cultureE" for="EmployeeNameE">@EPMS.Web.Resources.HR.Employee.Name</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeNameE, new { @id = "EmployeeNameE" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeeNameE)
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label cultureA" for="EmployeeNameA">@EPMS.Web.Resources.HR.Employee.Name</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeNameA, new { @id = "EmployeeNameA" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeeNameA)
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="JobTitle">Job Title</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.DropDownListFor(model => model.EmployeeViewModel.Employee.JobTitleId, new SelectList(Model.EmployeeViewModel.JobTitleList, "JobTitleId", "JobTitleNameE"), "--Select--", new { @class = "setDeptJobId", @id = "JobTitle" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.JobTitleId)
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="DepartmentName">Department</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @*@Html.TextBoxFor(model => model.EmployeeViewModel.Employee.DepartmentNameE, new { @id = "DepartmentName", @disabled = true })*@
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="JobID">Job ID</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.JobTitleId, new { @disabled = true, @id = "JobID" })
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="MobileNumber">Mobile Number</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeMobileNum, new { @id = "MobileNumber" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeeMobileNum)
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="LandlineNumber">Telephone Number</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeLandlineNum, new { @id = "LandlineNumber" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeeLandlineNum)
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="MaritalStatus">Marital Status</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.DropDownListFor(model => model.EmployeeViewModel.Employee.MaritalStatus, new[] { new SelectListItem { Text = "--Select--", Value = "" }, new SelectListItem { Text = "Unmaried", Value = "1" }, new SelectListItem { Text = "Married", Value = "0" } }, new { @id = "MaritalStatus" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.MaritalStatus)
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="EmployeeDOB">Date of Birth (Arabic-Gregorian)</label>
            </div>
            <div class="span9">
                <div class="controls span4">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmpDateOfBirthArabic, new { @class = "col-lg-2 datepickerArabic form-control ", onchange = "HijriToGregorian(this,'#EmployeeDOB')", @id = "EmpDateOfBirthArabic" })
                </div>
                <div class="controls span4">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeDOB, new { @class = "col-lg-2 datepicker form-control ", @id = "EmployeeDOB" })
                </div>
                @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeeDOB)
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="Nationality">Nationality</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.DropDownListFor(model => model.EmployeeViewModel.Employee.EmployeeNationality, new[] { new SelectListItem { Text = "--Select--", Value = "" }, new SelectListItem { Text = "Saudi Arabia", Value = "1" }, new SelectListItem { Text = "USA", Value = "2" } }, new { @id = "Nationality" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeeNationality)
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="IqamaId">Iqama Number Or National ID Number</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeIqama, new { @id = "IqamaId" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeeIqama)
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="IqamaIssueDate">Iqama Issue Date Or National ID Issue Date</label>
            </div>
            <div class="span9">
                <div class="controls span4">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeIqamaIssueDtAr, new { @id = "IqamaIssueDateAr", onchange = "HijriToGregorian(this,'#IqamaIssueDate')", @class = "col-lg-2 datepickerArabic form-control " })
                </div>
                <div class="controls span4">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeIqamaIssueDt, new { @id = "IqamaIssueDate", @class = "col-lg-2 datepicker form-control " })
                </div>
                @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeeIqamaIssueDt)
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="IqamaExpiryDate">Iqama Expiry Date Or National ID Expiry Date</label>
            </div>
            <div class="span9">
                <div class="controls span4">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeIqamaExpiryDtAr, new { @id = "IqamaExpiryDateAr", onchange = "HijriToGregorian(this,'#IqamaExpiryDate')", @class = "col-lg-2 datepickerArabic form-control " })
                </div>
                <div class="controls span4">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeIqamaExpiryDt, new { @id = "IqamaExpiryDate", @class = "col-lg-2 datepicker form-control " })
                </div>
                @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeeIqamaExpiryDt)
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="PassportID">Passport Id</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeePassportNum, new { @id = "PassportID" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeePassportNum)
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="PassportExpiryDate">Passport Expiry Date</label>
            </div>
            <div class="span9">
                <div class="controls span4">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeePassportExpiryDtAr, new { @id = "PassportExpiryDateAr", onchange = "HijriToGregorian(this,'#PassportExpiryDate')", @class = "col-lg-2 datepickerArabic form-control " })
                </div>
                <div class="controls span4">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeePassportExpiryDt, new { @id = "PassportExpiryDate", @class = "col-lg-2 datepicker form-control " })
                </div>
                @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeePassportExpiryDt)
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label cultureE" for="ExtraInformationE">@EPMS.Web.Resources.HR.Employee.ExtraInfo</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeDetailsE, new { @id = "ExtraInformationE" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeeDetailsE)
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label cultureA" for="ExtraInformationA">@EPMS.Web.Resources.HR.Employee.ExtraInfo</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.EmployeeDetailsA, new { @id = "ExtraInformationA" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.Employee.EmployeeDetailsA)
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="BasicSalary">Basic Salary</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.TextBoxFor(model => model.EmployeeViewModel.Employee.JobTitle.BasicSalary, new { @disabled = true, @id = "BasicSalary" })
                    @Html.ValidationMessageFor(m => m.EmployeeViewModel.JobTitle.BasicSalary)
                </div>
            </div>
        </div>
        @if (Roles.IsUserInRole("Admin") || Roles.IsUserInRole("PM"))
        {
            <div class="control-group row-fluid">
                <div class="span3">
                    <label class="control-label" for="Allownce1">Allownce1</label>
                </div>
                <div class="span9">
                    <div class="controls">
                        @Html.TextBoxFor(model => model.EmployeeViewModel.Allowance.Allowance1, new { @id = "Allownce1" })
                        @Html.ValidationMessageFor(m => m.EmployeeViewModel.Allowance.Allowance1)
                    </div>
                </div>
            </div>
            <div class="control-group row-fluid">
                <div class="span3">
                    <label class="control-label" for="Allownce2">Allownce2</label>
                </div>
                <div class="span9">
                    <div class="controls">
                        @Html.TextBoxFor(model => model.EmployeeViewModel.Allowance.Allowance2, new { @id = "Allownce2" })
                        @Html.ValidationMessageFor(m => m.EmployeeViewModel.Allowance.Allowance2)
                    </div>
                </div>
            </div>
            <div class="control-group row-fluid">
                <div class="span3">
                    <label class="control-label" for="Allownce3">Allownce3</label>
                </div>
                <div class="span9">
                    <div class="controls">
                        @Html.TextBoxFor(model => model.EmployeeViewModel.Allowance.Allowance3, new { @id = "Allownce3" })
                        @Html.ValidationMessageFor(m => m.EmployeeViewModel.Allowance.Allowance3)
                    </div>
                </div>
            </div>
            <div class="control-group row-fluid">
                <div class="span3">
                    <label class="control-label" for="Allownce4">Allownce4</label>
                </div>
                <div class="span9">
                    <div class="controls">
                        @Html.TextBoxFor(model => model.EmployeeViewModel.Allowance.Allowance4, new { @id = "Allownce4" })
                        @Html.ValidationMessageFor(m => m.EmployeeViewModel.Allowance.Allowance4)
                    </div>
                </div>
            </div>
            <div class="control-group row-fluid">
                <div class="span3">
                    <label class="control-label" for="Allownce5">Allownce5</label>
                </div>
                <div class="span9">
                    <div class="controls">
                        @Html.TextBoxFor(model => model.EmployeeViewModel.Allowance.Allowance5, new { @id = "Allownce5" })
                        @Html.ValidationMessageFor(m => m.EmployeeViewModel.Allowance.Allowance5)
                    </div>
                </div>
            </div>
            if (Model.EmployeeViewModel.Employee != null && Roles.IsUserInRole("Admin"))
            {
                <div class="control-group row-fluid">
                    <div class="span3">
                        <label class="control-label" for="Deduction1">Deduction1</label>
                    </div>
                    <div class="span9">
                        <div class="controls">

                        </div>
                    </div>
                </div>
                <div class="control-group row-fluid">
                    <div class="span3">
                        <label class="control-label" for="Deduction2">Deduction2</label>
                    </div>
                    <div class="span9">
                        <div class="controls">

                        </div>
                    </div>
                </div>
            }
        }
        @if (Model.EmployeeViewModel.Employee != null)
        {
            if (Roles.IsUserInRole("Employee"))
            {
                <div class="control-group row-fluid">
                    <div class="span3">
                        <label class="control-label" for=""><a>Payroll Page</a></label>
                    </div>
                </div>
            }
            <div class="alert alert-info alert-block">
                <i class="icon-alert icon-alert-info"></i>
                <strong>Requests History</strong>
            </div>
            <!--Sortable Responsive Table begin-->
            <div class="row-fluid">
                <div class="span12">
                    <table class="table table-striped table-responsive" id="tableRequsts">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Requests</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <!--Sortable Responsive Table end-->
            <div class="alert alert-info alert-block">
                <i class="icon-alert icon-alert-info"></i>
                <strong>Assigned Tasks</strong>
            </div>

            <!--Sortable Responsive Table begin-->
            <div class="row-fluid">
                <div class="span12">
                    <table class="table table-striped table-responsive" id="tableProjects">
                        <thead>
                            <tr>
                                <th> Tasks</th>
                                <th>Project Name</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        }
        @if ((Roles.IsUserInRole("Admin")) && Model.EmployeeViewModel.Employee != null)
        {
            <div class="control-group row-fluid">
                <div class="span3 span-inset">
                    <button type="submit" class="btn">@Model.EmployeeViewModel.BtnText</button>
                </div>
                <div class="span3 span-inset">
                    <button type="button" class="btn">Deactivate Employee</button>
                </div>
            </div>
        }
        else if (Roles.IsUserInRole("Admin"))
        {
            <div class="control-group row-fluid">
                <div class="span3 span-inset">
                    <button type="submit" class="btn">@Model.EmployeeViewModel.BtnText</button>
                </div>
            </div>
        }
    </div>
}
<script>
    $(document).ready(function () {
        // set JobId and Department Name
        $(".setDeptJobId").on("change", function () {
            var jobId = $(this).val();
            if (jobId != "") {
                $("#JobID").val(jobId);
                var jobsList = '@Html.Raw(Json.Encode(Model.EmployeeViewModel.JobTitleDeptList))';
                //'@Html.Raw(Json.Encode(Model.EmployeeViewModel.JobTitleDeptList))';
                var parsed = JSON.parse(jobsList);

                $.each(parsed, function (key, value) {
                    if (value.JobId == jobId) {
                        $("#DepartmentName").val(value.DeptNameE);
                        $("#BasicSalary").val(value.BasicSalary);
                    }
                });
            } else {
                $("#DepartmentName").val(jobId);
                $("#JobID").val(jobId);
            }
        });
        $('#tableProjects').dataTable({
            "sPaginationType": "bootstrap",
            "fnInitComplete": function () {
                $(".dataTables_wrapper select").select2({
                    dropdownCssClass: 'noSearch'
                });
            }
        });
        var siteUrl = $('#siteURL').val();
        var oTable = $('#tableRequsts').dataTable({
            "iDisplayLength": 20,
            "iDisplayStart": 0,
            "aaSorting": ['asc'],
            "bProcessing": true,
            "bServerSide": true,
            "bFilter": true,
            "aoColumns": [
                {
                    "aTargets": [0],
                    "sDefaultContent": "No Data",
                    "mRender": function (data, type, full) {
                        return full["RequestId"];
                    },
                    "bVisible": false,
                },
                {
                    "aTargets": [1],
                    "sDefaultContent": "No Data",
                    "mRender": function (data, type, full) {
                        var val = full["RequestTopic"];
                        var Id = full["RequestId"];
                        var element = '<a href="Create/' + Id + '">' + val + '</a>';
                        return element;
                    }
                }
            ],
            "sAjaxSource": siteUrl + "/Request/Index",
            "sServerMethod": "POST",
            "oLanguage": {
                "sProcessing": "Fetching record(s)",
                "sInfoEmpty": "No matching record(s) found",
                "sEmptyTable": "No record(s) found",
            },
        });
        $(".dataTables_length select").select2({
            dropdownCssClass: 'noSearch'
        });

        // Gregorian Date Picker
        $(".datepicker").mask('99/99/9999');
        $(".datepicker").datepicker({
            changeMonth: true,
            changeYear: true
        });
        // Arabic Date Picker for DOB
        var calendar = $.calendars.instance('islamic');
        $('.datepickerArabic').calendarsPicker({
            calendar: calendar,
            onSelect: function () {
                $(this).change();
            }
        });
        ConvertGregorianToIslamic();
        // Date from Gregorian to Islamic Starts
        $("#EmployeeDOB").on("change", function () {
            if ($('#EmployeeDOB').val() == "") {
                $('#EmpDateOfBirthArabic').val("");
            }
            else {
                var dateToBeChanged = $('#EmployeeDOB').val();
                var newDate = ConvertDates(dateToBeChanged, 'gregorian', 'islamic');
                $('#EmpDateOfBirthArabic').val(newDate);
            }
        });
        $("#IqamaIssueDate").on("change", function () {
            if ($('#IqamaIssueDate').val() == "") {
                $('#IqamaIssueDateAr').val("");
            }
            else {
                var dateToBeChanged = $('#IqamaIssueDate').val();
                var newDate = ConvertDates(dateToBeChanged, 'gregorian', 'islamic');
                $('#IqamaIssueDateAr').val(newDate);
            }
        });
        $("#IqamaExpiryDate").on("change", function () {
            if ($('#IqamaExpiryDate').val() == "") {
                $('#IqamaExpiryDateAr').val("");
            }
            else {
                var dateToBeChanged = $('#IqamaExpiryDate').val();
                var newDate = ConvertDates(dateToBeChanged, 'gregorian', 'islamic');
                $('#IqamaExpiryDateAr').val(newDate);
            }
        });
        $("#PassportExpiryDate").on("change", function () {
            if ($('#PassportExpiryDate').val() == "") {
                $('#PassportExpiryDateAr').val("");
            }
            else {
                var dateToBeChanged = $('#PassportExpiryDate').val();
                var newDate = ConvertDates(dateToBeChanged, 'gregorian', 'islamic');
                $('#PassportExpiryDateAr').val(newDate);
            }
        });
        // Date from Gregorian to Islamic Ends
    });

    function ConvertGregorianToIslamic() {
        $("#EmpDateOfBirthArabic").val(ConvertDates($("#EmployeeDOB").val(), "gregorian", "islamic"));
        $("#IqamaIssueDateAr").val(ConvertDates($("#IqamaIssueDate").val(), "gregorian", "islamic"));
        $("#IqamaExpiryDateAr").val(ConvertDates($("#IqamaExpiryDate").val(), "gregorian", "islamic"));
        $("#PassportExpiryDateAr").val(ConvertDates($("#PassportExpiryDate").val(), "gregorian", "islamic"));
    }
    function HijriToGregorian(currElement, toValue) {
        if ($(currElement).val() == "") {
            $(toValue).val("");
        }
        else {
            var splittedDate = $(currElement).val().split('/');
            $(currElement).val(splittedDate[1] + '/' + splittedDate[2] + '/' + splittedDate[0]);
            var dateToBeChanged = $(currElement).val();
            var newDate = ConvertDates(dateToBeChanged, 'islamic', 'gregorian');
            $(toValue).val(newDate);
        }
    }
    function ConvertDates(dateTobeChanged, fromCalender, toCalender) {
        var calender = $.calendars.instance(fromCalender);
        var dateToBeChanged = calender.parseDate("mm/dd/yyyy", dateTobeChanged);
        calender = $.calendars.instance(toCalender);
        var changedDate = calender.fromJD(dateToBeChanged.toJD());
        return calender.formatDate("mm/dd/yyyy", changedDate);
    }
</script>
