@model EPMS.Web.ViewModels.PurchaseOrder.PurchaseOrderCreateViewModel

@{
    if (Model.Order.PurchaseOrderId > 0)
    {
        ViewBag.Title = EPMS.Web.Resources.Inventory.PO.PO.PageTitleCreate;
    }
    else
    {
        ViewBag.Title = @EPMS.Web.Resources.Inventory.PO.PO.PageTitleEdit;
    }
    Layout = "~/Views/Shared/_Layout.cshtml";
    var direction = EPMS.Web.Resources.Shared.Common.TextDirection;
    string[] userPermissionsSet = (string[])HttpContext.Current.Session["UserPermissionSet"];
}

<div class="breadcrumb-container">
    <ul class="xbreadcrumbs">
        <li>
            <a href="~/Dashboard/Index">
                <i class="icon-photon home"></i>
            </a>
        </li>
        <li>
            <a href="~/Inventory/PurchaseOrder/Index">
                @EPMS.Web.Resources.Inventory.PO.PO.PageTitleIndex
            </a>
        </li>
        <li class="current">
            <a href="javascript:;">
                @ViewBag.Title
            </a>
        </li>
    </ul>
</div>

<header>
    <i class="icon-big-notepad"></i>
    @if (Model.Order.PurchaseOrderId > 0)
    {
        <h2><small>@EPMS.Web.Resources.Inventory.PO.PO.POCreate</small></h2>
    }
    else
    {
        <h2><small>@EPMS.Web.Resources.Inventory.PO.PO.POEdit</small></h2>
    }
</header>
<!--Notifications begin-->
@Html.Partial("_Alert")
<!--Notifications end-->
@using (Html.BeginForm("Create", "PurchaseOrder", FormMethod.Post, new { @class = "form-horizontal", @id = "AddEditItemReleaseForm", role = "form", enctype = "multipart/form-data" }))
{
    @Html.HiddenFor(model => model.Order.PurchaseOrderId)
    @Html.HiddenFor(model => model.Order.FormNumber)
    @Html.HiddenFor(model => model.Order.ManagerId)
    @Html.HiddenFor(model => model.Order.NotesE)
    @Html.HiddenFor(model => model.Order.NotesA)
    @Html.HiddenFor(model => model.Order.Status)
    @Html.HiddenFor(model => model.Order.RecCreatedBy)
    @Html.HiddenFor(model => model.Order.RecCreatedDate)
    <div class="container-fluid">
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="createdBy">@EPMS.Web.Resources.Inventory.PO.PO.CreatedBy</label>
            </div>
            <div class="span9">
                <div class="controls">
                    @Html.TextBoxFor(m => m.Order.RequesterName, new { @id = "", @class = "disableOnLoad" })
                </div>
            </div>
        </div>
        
        <div class="row-fluid" id="ress">
            <div class="span12">
                <table class="table table-striped table-responsive ">
                    <thead class="">
                        <tr>
                            <th>@EPMS.Web.Resources.Inventory.PO.PO.Serial</th>
                            <th style="width:75%">@EPMS.Web.Resources.Inventory.PO.PO.ItemDetails</th>
                            <th>@EPMS.Web.Resources.Inventory.PO.PO.NeededQuantity</th>
                            <th style="width:4%">@EPMS.Web.Resources.Inventory.PO.PO.Delete</th>
                        </tr>
                    </thead>
                    <tbody id="PoItemsTableBody" class="qouteAdd">
                        @if (Model.PoItems.Any())
                        {
                            for (int i = 0; i < Model.PoItems.Count(); i++)
                            {
                                <tr data-id=@i>
                                    <td style='display: none'>
                                        <input name='PoItems.Index' type='hidden' value=@i />
                                        @Html.HiddenFor(m => m.PoItems[i].IsItemDescription)
                                        @Html.HiddenFor(m => m.PoItems[i].IsItemSKU)
                                        @Html.HiddenFor(m => m.PoItems[i].ItemVariationId)
                                        @Html.HiddenFor(m => m.PoItems[i].ItemId)
                                        @Html.HiddenFor(m => m.PoItems[i].PlaceInDepartment)
                                        @Html.HiddenFor(m => m.PoItems[i].RecCreatedBy)
                                        @Html.HiddenFor(m => m.PoItems[i].RecCreatedDate)
                                    </td>
                                    <td>
                                        <div class="control-group row-fluid">
                                            <div class="span1">
                                                <label class="control-label serialNumber">@(i + 1)</label>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        @Html.TextAreaFor(m => m.PoItems[i].ItemDetails, new { @class = "auto-resize toBeDisable", @rows = 2 })
                                        <button type="button" class="btn itemAdder btnDisable" data-toggle="modal" data-target="#itemSearcher">+</button>
                                        @Html.ValidationMessageFor(m => m.PoItems[i].ItemDetails)
                                    </td>
                                    <td class="quantity">
                                        @Html.TextBoxFor(m => m.PoItems[i].ItemQty, new { @class = "n1 toBeDisable", @rows = 2 })
                                        @Html.ValidationMessageFor(m => m.PoItems[i].ItemQty, null, new { @class = "required" })
                                    </td>
                                    <td class="delete">
                                        <i class="icon-photon minus deleteRow"></i>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr data-id="0">
                                <td style='display:none'>
                                    <input name='PoItems.Index' type='hidden' value='0' />
                                    <input name='PoItems[0].IsItemDescription' id='PoItems_0__IsItemDescription' type='hidden' />
                                    <input name='PoItems[0].IsItemSKU' id='PoItems_0__IsItemSKU' type='hidden' />
                                    <input name='PoItems[0].ItemVariationId' id='PoItems_0__ItemVariationId' type='hidden' />
                                    <input name='PoItems[0].PlaceInDepartment' id='PoItems_0__PlaceInDepartment' type='hidden' />
                                </td>
                                <td>
                                    <div class="control-group row-fluid">
                                        <div class="span1">
                                            <label class="control-label serialNumber">1</label>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <textarea rows="2" id='PoItems_0__ItemDetails' class="auto-resize toBeDisable" data-val="true" data-val-required="The Item Details field is required." name="PoItems[0].ItemDetails"></textarea>
                                    <button type="button" class="btn itemAdder btnDisable" data-toggle="modal" data-target="#itemSearcher">+</button>
                                    <span class="field-validation-valid required" data-valmsg-for="PoItems[0].ItemDetails" data-valmsg-replace="true"></span>
                                </td>
                                <td class="quantity">
                                    <input class="n1 toBeDisable" id='PoItems_0__ItemQty' type="text" name="PoItems[0].ItemQty" value="0" data-val="true" data-val-number="The field Item Qty must be a number." data-val-range="Please enter valid quantity" data-val-range-max="2147483647" data-val-range-min="1" data-val-required="The Item Qty field is required.">
                                    <span class="field-validation-valid required" data-valmsg-for="PoItems[0].ItemQty" data-valmsg-replace="true"></span>
                                </td>
                                <td class="delete">
                                    <i class="icon-photon minus deleteRow"></i>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="control-group row-fluid">
                <div class="span3 span-inset">
                    <button type="button" class="btn trAdder btnDisable">@EPMS.Web.Resources.Inventory.PO.PO.Add</button>
                </div>
            </div>
        </div>
        <div id="EditRecord" class="control-group row-fluid" style="display: none">
            <div class="span3 span-inset">
                <button id="edit" type="button" class="btn">@EPMS.Web.Resources.Inventory.PO.PO.Edit</button>
            </div>
        </div>
        <div id="SubmitRecord" class="control-group row-fluid">
            <div class="span3 span-inset">
                <button type="submit" class="btn">@EPMS.Web.Resources.Inventory.PO.PO.Submit</button>
            </div>
        </div>
    </div>
}
@section popups
{
    @Html.Partial("_ItemsPopUp")
}
<script>
    var status;
    var siteUrl;
    var textTillParent = "";
    var dir = '@direction';
    $(document).ready(function () {
        status = '@Model.Order.Status';
        siteUrl = $("#siteURL").val();
        $('.' + 'disableOnLoad' + ':input').attr('readonly', true);
        var itemId = parseInt('@Model.Order.PurchaseOrderId');
        if (itemId > 0) {
            // disable on load section
            $('.btnDisable').addClass('disableList');
            $('.' + 'toBeDisable' + ':input').attr('readonly', true);
            $("#SubmitRecord").hide();
            if (status != 1 && '@userPermissionsSet.Contains("POCreate")' == 'True') {
                $("#EditRecord").show();
            }
        }
        $('.trAdder').on("click", function () {
            var index = $("#PoItemsTableBody").children("tr").length;
            var indexCell = "<td style='display:none'>" +
                "<input name='PoItems.Index' type='hidden' value='" + index + "' />" +
                "<input name='PoItems[" + index + "].IsItemDescription' id='PoItems_" + index + "__IsItemDescription' type='hidden' />" +
                "<input name='PoItems[" + index + "].IsItemSKU' id='PoItems_" + index + "__IsItemSKU' type='hidden' />" +
                "<input name='PoItems[" + index + "].ItemVariationId' id='PoItems_" + index + "__ItemVariationId' type='hidden' />" +
                "<input name='PoItems[" + index + "].PlaceInDepartment' id='PoItems_" + index + "__PlaceInDepartment' type='hidden' />" +
                "</td>";
            //DifItem
            var html = ' <tr data-id=' + index + '>' +
                indexCell +
                '<td>' +
                '<div class="control-group row-fluid">' +
                '<div class="span1">' +
                '<label class="control-label serialNumber"  ></label>' +
                '</div></div>' +
                '</td>' +
                '<td> <textarea rows="2"  class="auto-resize"  id="PoItems_' + index + '__ItemDetails" name="PoItems[' + index + '].ItemDetails" data-val="true" data-val-required="The Item Details field is required."></textarea>' +
                '<button type="button" class="btn itemAdder btnDisable" data-toggle="modal" data-target="#itemSearcher" >+</button>' +
                '<span class="field-validation-valid required" data-valmsg-for="PoItems[' + index + '].ItemDetails" data-valmsg-replace="true"></span>' +
                '</td>' +
                '<td class="quantity"> ' +
                '<input class="n1" type="text" id="PoItems_' + index + '_ItemQty" name="PoItems[' + index + '].ItemQty" data-val="true" data-val-number="The field Item Qty must be a number." data-val-range="Please enter valid quantity" data-val-range-max="2147483647" data-val-range-min="1" data-val-required="The Item Qty field is required." value=0>' +
                '<span class="field-validation-valid required" data-valmsg-for="PoItems[' + index + '].ItemQty" data-valmsg-replace="true"></span>' +
                '</td>' +
                '<td class="delete"> <i class="icon-photon minus deleteRow"></i>' +
                '</td></tr>';

            $('.qouteAdd').append(html);
            //remove validation
            $("form").removeData("validator").removeData("unobtrusiveValidation");

            //Parse the form again to apply new validations
            $.validator.unobtrusive.parse("form");

            activateSerial();
            reActivateDelete();
        });
        reActivateDelete();
        //reactivateCount();
        function reActivateDelete() {
            $('.deleteRow').on("click", function () {
                var count = $('.qouteAdd tr').length;
                if (count > 1) {
                    $(this).parent().parent().remove();
                }
                activateSerial();
            });
        }
        function activateSerial() {
            var count = $('.qouteAdd tr').length;
            var add = 0;
            $('.qouteAdd tr').each(function () {
                add++;
                $(this).find(".serialNumber").text(add);
            });
        }
        var treeInitialData;
        if (dir == "ltr") {
            treeInitialData = [
                {
                    "data": {
                        "title": "Departments",
                        "attr": { "href": "#", "onclick": "jsTreeClick(event)" }
                    },
                    "attr": { "id": "parentNode" },
                }
            ];
        } else {
            treeInitialData = [
                {
                    "data": {
                        "title": "الإدارات",
                        "attr": { "href": "#", "onclick": "jsTreeClick(event)" }
                    },
                    "attr": { "id": "parentNode" },
                }
            ];
        }
        $("#jstree").jstree({
            "json_data": {
                "data": treeInitialData
            },
            "plugins": ["themes", "json_data", "ui"],
            "ui": {
                "initially_select": ["parentNode"]
            },
            "core": {
                "initially_open": ["parentNode"]
            }
        }).bind("select_node.jstree", function (event, data) {
            //`data.rslt.obj` is the jquery extended node that was clicked          
            if (data.inst._get_parent(data.rslt.obj) != -1) {
                var parents = [];
                textTillParent = "";
                data.rslt.obj.parents("li").each(function () {
                    parents.push({ id: $(this).attr("id"), description: $(this).children("a").text() });
                });
                $.each(parents, function (key, value) {
                    textTillParent = value.description + " >" + textTillParent;
                });
                textTillParent = textTillParent + $(".jstree-clicked").text();
            }
        });
        var requestUrl = siteUrl + "/Inventory/InventoryDepartment/GetAllDepartments";
        populateTree(0, "jstree", requestUrl);

        $("#btnTreeSelector").click(function (event) {
            $('#itemTreeSelector').modal('show');
            event.preventDefault();
            $.fn.modal.Constructor.prototype.enforceFocus = function () { };
        });
        $("#selectDepartment").on("click", function () {
            var index = parseInt($("#ItemModalIndex").val());
            $("#PoItems_" + index + "__PlaceInDepartment").val(textTillParent);
            $("#txtSelectedDepartmentName").text("Selected :" + textTillParent);
            $('#itemTreeSelector').modal('toggle');
            return true;
        });
        //open pop up
        $('#itemSearcher').on('show', function () {
            //clear DDL required value label
            $("#ItemVariationDropDownListValidation").text("");
            $("#ItemVariationDropDownListValidation").removeClass("Error");

            //get the id from tr that is selected for the item popup
            var index = $(event.target).closest('tr').data('id');
            $("#ItemModalIndex").val(index);
            //get item's values
            var isItemDescription = $("#PoItems_" + index + "__IsItemDescription").val();
            var isItemSKU = $("#PoItems_" + index + "__IsItemSKU").val();
            var itemVariationId = $("#PoItems_" + index + "__ItemVariationId").val();
            var placeInDepartment = $("#PoItems_" + index + "__PlaceInDepartment").val();
            // clear selected department label text
            $("#txtSelectedDepartmentName").text("");

            //set modal fields according to modal values
            $("#ItemVariationDropDownList").select2("val", itemVariationId); //set the value

            if (isItemDescription == "false" || isItemDescription == "False" || isItemDescription == "") {
                $('#ItemDescriptionModalChk').attr('checked', false);
            } else {
                $('#ItemDescriptionModalChk').attr('checked', true);
            }

            if (isItemSKU == "false" || isItemSKU == "False" || isItemSKU == "") {
                $('#ItemSKUModalChk').attr('checked', false);
            } else {
                $('#ItemSKUModalChk').attr('checked', true);
            }
            $("#txtSelectedDepartmentName").text("Selected :" + placeInDepartment);
        });
        function getModalControlsValues() {
            //get item's values
            var isItemDescription = $('#ItemDescriptionModalChk').is(':checked');
            var isItemSku = $('#ItemSKUModalChk').is(':checked');
            var itemVariationId = $("#ItemVariationDropDownList").val();

            //set item's values
            var index = $("#ItemModalIndex").val();
            $("#PoItems_" + index + "__IsItemDescription").val(isItemDescription);
            $("#PoItems_" + index + "__IsItemSKU").val(isItemSku);
            $("#PoItems_" + index + "__ItemVariationId").val(itemVariationId);

            //set item sku and description in details text area
            var rfiItems = '@Html.Raw(Json.Encode(Model.ItemVariationDropDownList))';
            var parsedRfiItems = JSON.parse(rfiItems);

            $.each(parsedRfiItems, function (key, value) {
                if (value.ItemVariationId == itemVariationId) {
                    $("#PoItems_" + index + "__ItemDetails").val("");
                    var textToAppend = "";
                    if ('@direction' == "ltr") {
                        textToAppend = textToAppend + "Name: " + value.ItemNameE;
                    } else {
                        textToAppend = textToAppend + "Name: " + value.ItemNameA;
                    }
                    if (isItemSku) {
                        textToAppend = textToAppend + "\nSKU Code: " + value.SKUCode;
                    }
                    if (isItemDescription) {
                        if ('@direction' == "ltr") {
                            textToAppend = textToAppend + "\nDescription: " + value.ItemVariationDescriptionE;
                        } else {
                            textToAppend = textToAppend + "\nDescription: " + value.ItemVariationDescriptionA;
                        }
                    }
                    $("#PoItems_" + index + "__ItemDetails").val(textToAppend);
                }
            });
            $('#itemSearcher').modal('toggle');
        };
        $("#SaveChanges").on("click", function () {
            if (validateSelect2Ddl("#ItemVariationDropDownList")) {
                getModalControlsValues();
            }
        });
        
        $("#btnTreeSelector").click(function (event) {
            event.preventDefault();
            $.fn.modal.Constructor.prototype.enforceFocus = function () { };
        });
    });
    $("#edit").on('click', function () {
        if (status != 1) {
            AddEdit();
        }
    });
    $('#tiny').elrte({
        lang: "en",
        styleWithCSS: false,
        height: 200,
        toolbar: 'tiny'
    });
    function AddEdit() {
        if (status != 1) {
            var isDetail;
            var val = '@userPermissionsSet.Contains("POCreate")';
            if (val == 'True') {
                isDetail = false;
            } else {
                isDetail = true;
            }
            if (isDetail) {

            } else {
                $('.btnDisable').removeClass('disableList');
                $('.' + 'toBeDisable' + ':input').attr('readonly', false);
                $("#EditRecord").hide();
                $("#SubmitRecord").show();
            }
        }
    }
    function jsTreeClick(event) {
        return true;
    }
</script>