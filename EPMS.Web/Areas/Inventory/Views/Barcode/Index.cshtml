@model EPMS.WebModels.ViewModels.Barcode.BarcodeViewModel
@{
    ViewBag.Title = EPMS.WebModels.Resources.Inventory.Barcode.Barcode.PageTitle;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var direction = EPMS.WebModels.Resources.Shared.Common.TextDirection;
}

<div class="breadcrumb-container">
    <ul class="xbreadcrumbs">
        <li>
            <a href="~/Dashboard/Index">
                <i class="icon-photon home"></i>
            </a>
        </li>

        <li class="current">
            <a href="javascript:;">@ViewBag.Title</a>
        </li>
    </ul>
</div>

<header>
    <i class="icon-big-notepad"></i>
    <h2><small>@EPMS.WebModels.Resources.Inventory.Barcode.Barcode.Header</small></h2>
</header>
<form class="form-horizontal" id="form-barcode-print">
    <div class="container-fluid">

        <div id="demo" style="display: none"></div>

        <div class="row-fluid" id="ress">
            <div class="span12">
                <table class="table table-striped table-responsive ">
                    <thead class="">
                        <tr>
                            <th>@EPMS.WebModels.Resources.Shared.Common.Serial</th>
                            <th style="width:65%">@EPMS.WebModels.Resources.Inventory.Barcode.Barcode.ItemDetails</th>
                            <th style="width:18%">@EPMS.WebModels.Resources.Inventory.Barcode.Barcode.BarcodeValue</th>
                            <th style="width:6%">@EPMS.WebModels.Resources.Inventory.Barcode.Barcode.Print</th>
                            <th style="width:4%">@EPMS.WebModels.Resources.Inventory.Barcode.Barcode.Delete</th>
                        </tr>
                    </thead>
                    <tbody class="qouteAdd" id="BarcodeTableBody">
                        <tr data-id="0">
                            <td>
                                <div class="control-group row-fluid">
                                    <div class="span1">
                                        <label class="control-label serialNumber">1</label>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <textarea rows="2" class="auto-resize" id='Barcodes_0__ItemDetails' name="Barcodes[0].ItemDetails" data-val="true" data-val-required="The Item Details field is required."></textarea>
                                <button type="button" class="btn itemAdder" data-toggle="modal" data-target="#itemSearcher">+</button>
                                <span class="field-validation-valid required" data-valmsg-for="Barcodes[0].ItemDetails" data-valmsg-replace="true"></span>
                            </td>
                            <td>
                                <div id="BarcodeValue_0"></div>
                                <textarea rows="2" style="display: none" class="auto-resize" id='Barcodes_0__BarcodeValue' name="Barcodes[0].BarcodeValue"></textarea>
                            </td>
                            <td>
                                <button type="button" class="btn tableBtn print">@EPMS.WebModels.Resources.Inventory.Barcode.Barcode.Print</button>
                            </td>
                            <td class="delete">
                                <i class="icon-photon minus deleteRow"></i>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="control-group row-fluid">
                <div class="span3 span-inset">
                    <button type="button" class="btn trAdder">@EPMS.WebModels.Resources.Inventory.Barcode.Barcode.Add</button>
                </div>
            </div>
        </div>
    </div>
</form>

@section popups
{
    @Html.Partial("_BarcodeItemsPopUp")
}

<link href="http://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">
<!-- Barcode Generation Library -->
<script type="text/javascript" src="~/Scripts/App/Barcode/jquery-barcode.js"></script>
<!-- jQuery Print Element -->
<script type="text/javascript" src="~/Scripts/App/Barcode/jquery.printElement.js"></script>
<link href="~/Content/CSS/jsTreeCheckbox/style.css" rel="stylesheet" />
<script>
    var siteUrl;
    var divId;
    var dir = '@direction';
    var errorMessageTree = '@EPMS.WebModels.Resources.Shared.Common.RequiredTreeField';
    $(document).ready(function () {
        divId = "jstree";
        siteUrl = $("#siteURL").val();
        $('.trAdder').on("click", function () {
            var index = $("#BarcodeTableBody").children("tr").length;
            var html = ' <tr data-id="' + index + '">' +
                '<td ><div class="control-group row-fluid"><div class="span1">' +
                '<label class="control-label serialNumber"></label></div></div></td>' +
                '<td><textarea rows="2" class="auto-resize" id="Barcodes_' + index + '__ItemDetails" name="Barcodes[' + index + '].ItemDetails" data-val="true" data-val-required="The Item Details field is required."></textarea>' +
                '<button type="button" class="btn itemAdder" data-toggle="modal" data-target="#itemSearcher" >+</button>' +
                '<span class="field-validation-valid required" data-valmsg-for="Barcodes[' + index + '].ItemDetails" data-valmsg-replace="true"></span> </td>' +
                '<td ><div id="BarcodeValue_' + index + '"></div>' +
                '<textarea rows="2" style="display: none" class="auto-resize" id="Barcodes_' + index + '__BarcodeValue" name="Barcodes[' + index + '].BarcodeValue"></textarea></td>' +
                '<td><button type="button" class="btn tableBtn print">Print</button> </td>' +
                '<td class="delete"> <i class="icon-photon minus deleteRow"></i> </td></tr>';
            $('.qouteAdd').append(html);
            //remove validation
            $("form").removeData("validator").removeData("unobtrusiveValidation");

            //Parse the form again to apply new validations
            $.validator.unobtrusive.parse("form");

            activateSerial();
            reActivateDelete();
            reActivatePrint();

        });
        reActivateDelete();
        function reActivateDelete() {
            $('.deleteRow').on("click", function () {
                var count = $('.qouteAdd tr').length;
                if (count > 1) {
                    $(this).parent().parent().remove();
                }
                activateSerial();
            });
        }
        function activateSerial() {
            var count = $('.qouteAdd tr').length;
            var add = 0;
            $('.qouteAdd tr').each(function () {
                add++;
                $(this).find(".serialNumber").text(add);
            });
        }
        $("#btnTreeSelector").click(function (event) {
            $('#itemTreeSelector').modal('show');
            event.preventDefault();
            $.fn.modal.Constructor.prototype.enforceFocus = function () { };
        });
        $("#selectDepartment").on("click", function () {
            var selectedItem = $(".jstree-clicked").text();
            // validation
            if (selectedItem == "" || selectedItem == null) {
                $("#selectedItemTreeValidation").text(errorMessageTree);
                $("#selectedItemTreeValidation").addClass("Error");
                return;
            } else {
                $("#selectedItemTreeValidation").text("");
                $("#selectedItemTreeValidation").removeClass("Error");
            }
            var rfiItems = '@Html.Raw(Json.Encode(Model.ItemVariationDropDownList))';
            var parsedRfiItems = JSON.parse(rfiItems);
            $.each(parsedRfiItems, function (key, value) {
                if (value.ItemCodeSKUCodeDescriptoinEn == selectedItem) {
                    $("#ItemVariationTree").val(value.ItemVariationId);
                }
            });
            var item = $("#ItemVariationTree").val();
            if (item == "" || item == 0 || item == null) {
                $("#selectedItemTreeValidation").text(errorMessageTree);
                $("#selectedItemTreeValidation").addClass("Error");
                return;
            } else {
                $("#selectedItemTreeValidation").text("");
                $("#selectedItemTreeValidation").removeClass("Error");
            }
            $('#itemTreeSelector').modal('toggle');
            return true;
        });
        $('#itemSearcher').on('show', function () {
            //clear DDL required value label
            $("#ItemVariationDropDownListValidation").text("");
            $("#ItemVariationDropDownListValidation").removeClass("Error");

            //get the id from tr that is selected for the item popup
            var index = $(event.target).closest('tr').data('id');
            $("#ItemModalIndex").val(index);
            $("#ItemVariationDropDownList").val("");
            $(".select2me").select2("destroy");
            $('.select2me').select2({
                //placeholder: "Select",
            });
            var itemTreeUrl = siteUrl + "/Api/Tree/GetTreeData/";
            populateTreeJsonWTCkb(itemTreeUrl, divId, dir);
        });
        $("#SaveChanges").on("click", function () {
            var createFrom = $("input[name=ItemFrom]:checked").val();
            if (createFrom == "dropdown") {
                if (validateSelect2Ddl("#ItemVariationDropDownList", '@EPMS.WebModels.Resources.Shared.Common.RequiredDdlField')) {
                    getModalControlsValues();
                }
            } else {
                getModalControlsValuesForTree();
            }
        });
        function getModalControlsValues() {
            //get item's values
            var isItemSku = $('#ItemSKUModalChk').is(':checked');
            var itemVariationId = $("#ItemVariationDropDownList").val();

            //set item's values
            var index = $("#ItemModalIndex").val();

            //set item sku and description in details text area
            var rfiItems = '@Html.Raw(Json.Encode(Model.ItemVariationDropDownList))';
            var parsedRfiItems = JSON.parse(rfiItems);

            $.each(parsedRfiItems, function (key, value) {
                if (value.ItemVariationId == itemVariationId) {
                    $("#Barcodes_" + index + "__ItemDetails").val("");
                    var textToAppend = "";
                    var barcodeValue;
                    if ('@direction' == "ltr") {
                        textToAppend = textToAppend + "Name: " + value.ItemNameE;
                    } else {
                        textToAppend = textToAppend + "Name: " + value.ItemNameA;
                    }
                    if (isItemSku) {
                        if ('@direction' == "ltr") {
                            textToAppend = textToAppend + "\nItem SKU description: " + value.ItemSKUDescriptoinEn;
                        } else {
                            textToAppend = textToAppend + "\nItem SKU description: " + value.ItemSKUDescriptoinAr;
                        }
                    }
                    barcodeValue = value.ItemCodeSKUCode;
                    $("#Barcodes_" + index + "__ItemDetails").val(textToAppend);
                    $("#Barcodes_" + index + "__BarcodeValue").val(barcodeValue);
                }
            });
            generateBarcode(index);
            $('#itemSearcher').modal('toggle');
        }
        function getModalControlsValuesForTree() {
            //get item's values
            var isItemSku = $('#ItemSKUModalChk').is(':checked');
            var itemVariationId = $("#ItemVariationTree").val();

            //set item's values
            var index = $("#ItemModalIndex").val();

            //set item sku and description in details text area
            var rfiItems = '@Html.Raw(Json.Encode(Model.ItemVariationDropDownList))';
            var parsedRfiItems = JSON.parse(rfiItems);

            $.each(parsedRfiItems, function (key, value) {
                if (value.ItemVariationId == itemVariationId) {
                    $("#Barcodes_" + index + "__ItemDetails").val("");
                    var textToAppend = "";
                    var barcodeValue;
                    if ('@direction' == "ltr") {
                        textToAppend = textToAppend + "Name: " + value.ItemNameE;
                    } else {
                        textToAppend = textToAppend + "Name: " + value.ItemNameA;
                    }
                    if (isItemSku) {
                        if ('@direction' == "ltr") {
                            if (value.ItemSKUDescriptoinEn == null) {
                                textToAppend = textToAppend + "\nItem SKU description:";
                            } else {
                                textToAppend = textToAppend + "\nItem SKU description: " + value.ItemSKUDescriptoinEn;
                            }
                        } else {
                            if (value.ItemSKUDescriptoinAr == null) {
                                textToAppend = textToAppend + "\nItem SKU description:";
                            } else {
                                textToAppend = textToAppend + "\nItem SKU description: " + value.ItemSKUDescriptoinAr;
                            }
                        }
                    }
                    barcodeValue = value.ItemCodeSKUCode;
                    $("#Barcodes_" + index + "__ItemDetails").val(textToAppend);
                    $("#Barcodes_" + index + "__BarcodeValue").val(barcodeValue);
                }
            });
            generateBarcode(index);
            $('#itemSearcher').modal('toggle');
        }
        reActivatePrint();
        function reActivatePrint() {
            $(".print").unbind();
            $(".print").on('click', function (event) {
                //event.preventDefault();
                var index = $(this).parent().parent().get(0).rowIndex - 1;
                var validStatus = $("#Barcodes_" + index + "__ItemDetails").valid();
                if (validStatus) {
                    $("#BarcodeValue_" + index).show().printElement();
                }
            });
        }
        var $radios = $('input:radio[name=ItemFrom]');
        $radios.filter('[value=dropdown]').prop('checked', true);
        $("#Simple_Select_Box_with_Filter_Search").show();
        $("#treeControl").hide();
        $("input[name=ItemFrom]:radio").change(function () {
            if ($(this).val() == "dropdown") {
                $("#Simple_Select_Box_with_Filter_Search").show();
                $("#treeControl").hide();
            }
            if ($(this).val() == "tree") {
                $("#Simple_Select_Box_with_Filter_Search").hide();
                $("#treeControl").show();
            }
        });
    });
    $('#tiny').elrte({
        lang: "en",
        styleWithCSS: false,
        height: 200,
        toolbar: 'tiny'
    });
    function generateBarcode(index) {
        var barcodeValue = $("#Barcodes_" + index + "__BarcodeValue").val();
        barcodeValue = { code: barcodeValue, rect: true };
        var btype = "code128";
        var settings = {
            barWidth: 1,
            barHeight: 50,
            moduleSize: 5,
            showHRI: true,
            addQuietZone: true,
            marginHRI: 5,
            bgColor: "#FFFFFF",
            color: "#000000",
            fontSize: 10,
            output: "css",
            posX: 0,
            posY: 0
        };
        $("#BarcodeValue_" + index).barcode(barcodeValue, btype, settings);
    }
</script>