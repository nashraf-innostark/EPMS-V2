@model EPMS.Web.ViewModels.Barcode.BarcodeViewModel
@{
    ViewBag.Title = "Inventory Barcode Printer";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var direction = EPMS.Web.Resources.Shared.Common.TextDirection;
}

<div class="breadcrumb-container">
    <ul class="xbreadcrumbs">
        <li>
            <a href="~/Dashboard/Index">
                <i class="icon-photon home"></i>
            </a>
        </li>

        <li class="current">
            <a href="javascript:;">@ViewBag.Title</a>
        </li>
    </ul>
</div>

<header>
    <i class="icon-big-notepad"></i>
    <h2><small>Barcode Printer</small></h2>
</header>
<form class="form-horizontal" id="form-barcode-print">
    <div class="container-fluid">

        <div id="demo" style="display: none"></div>

        <div class="row-fluid" id="ress">
            <div class="span12">
                <table class="table table-striped table-responsive ">
                    <thead class="">
                        <tr>
                            <th>Serial</th>
                            <th style="width:65%">Item Details</th>
                            <th style="width:18%">Barcode</th>
                            <th style="width:6%">Print</th>
                            <th style="width:4%">Delete</th>
                        </tr>
                    </thead>
                    <tbody class="qouteAdd" id="BarcodeTableBody">
                        <tr data-id="0">
                            <td>
                                <div class="control-group row-fluid">
                                    <div class="span1">
                                        <label class="control-label serialNumber">1</label>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <textarea rows="2" class="auto-resize" id='Barcodes_0__ItemDetails' name="Barcodes[0].ItemDetails" data-val="true" data-val-required="The Item Details field is required."></textarea>
                                <button type="button" class="btn itemAdder" data-toggle="modal" data-target="#itemSearcher">+</button>
                                <span class="field-validation-valid required" data-valmsg-for="Barcodes[0].ItemDetails" data-valmsg-replace="true"></span>
                            </td>
                            <td>
                                <div id="BarcodeValue_0"></div>
                                <textarea rows="2" style="display: none" class="auto-resize" id='Barcodes_0__BarcodeValue' name="Barcodes[0].BarcodeValue"></textarea>
                            </td>
                            <td>
                                <button type="button" class="btn tableBtn print">Print</button>
                            </td>
                            <td class="delete">
                                <i class="icon-photon minus deleteRow"></i>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="control-group row-fluid">
                <div class="span3 span-inset">
                    <button type="button" class="btn trAdder">Add</button>
                </div>
            </div>
        </div>
        @*<div class="control-group row-fluid">
                <div class="span3 span-inset">
                    <button type="button" class="btn" id="print">Print</button>
                </div>
            </div>*@
    </div>
</form>

@section popups
{
    @Html.Partial("_ItemsPopUp")
}

<link href="http://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">
<!-- Barcode Generation Library -->
<script type="text/javascript" src="~/Scripts/App/Barcode/jquery-barcode.js"></script>
<!-- jQuery Print Element -->
<script type="text/javascript" src="~/Scripts/App/Barcode/jquery.printElement.js"></script>
<script>
    $(document).ready(function () {
        $('.trAdder').on("click", function () {
            var index = $("#BarcodeTableBody").children("tr").length;
            var html = ' <tr data-id="' + index + '">' +
                '<td ><div class="control-group row-fluid"><div class="span1">' +
                    '<label class="control-label serialNumber"></label></div></div></td>' +
                '<td><textarea rows="2" class="auto-resize" id="Barcodes_' + index + '__ItemDetails" name="Barcodes[' + index + '].ItemDetails" data-val="true" data-val-required="The Item Details field is required."></textarea>' +
                    '<button type="button" class="btn itemAdder" data-toggle="modal" data-target="#itemSearcher" >+</button>' +
                    '<span class="field-validation-valid required" data-valmsg-for="Barcodes[' + index + '].ItemDetails" data-valmsg-replace="true"></span> </td>' +
                '<td ><div id="BarcodeValue_' + index + '"></div>' +
                    '<textarea rows="2" style="display: none" class="auto-resize" id="Barcodes_' + index + '__BarcodeValue" name="Barcodes[' + index + '].BarcodeValue"></textarea></td>' +
                '<td><button type="button" class="btn tableBtn print">Print</button> </td>' +
                '<td class="delete"> <i class="icon-photon minus deleteRow"></i> </td></tr>';
            $('.qouteAdd').append(html);
            //remove validation
            $("form").removeData("validator").removeData("unobtrusiveValidation");

            //Parse the form again to apply new validations
            $.validator.unobtrusive.parse("form");

            activateSerial();
            reActivateDelete();
            reActivatePrint();

        });
        reActivateDelete();
        function reActivateDelete() {
            $('.deleteRow').on("click", function () {
                var count = $('.qouteAdd tr').length;
                if (count > 1) {
                    $(this).parent().parent().remove();
                }
                activateSerial();
            });
        }
        function activateSerial() {
            var count = $('.qouteAdd tr').length;
            var add = 0;
            $('.qouteAdd tr').each(function () {
                add++;
                $(this).find(".serialNumber").text(add);
            });
        }
        $('#itemSearcher').on('show', function () {
            $(".tree-selector").hide();
            //clear DDL required value label
            $("#ItemVariationDropDownListValidation").text("");
            $("#ItemVariationDropDownListValidation").removeClass("Error");

            //get the id from tr that is selected for the item popup
            var index = $(event.target).closest('tr').data('id');
            $("#ItemModalIndex").val(index);
            $("#ItemVariationDropDownList").val("");
            $(".select2me").select2("destroy");
            $('.select2me').select2({
                //placeholder: "Select",
            });
        });
        $("#SaveChanges").on("click", function () {
            if (validateSelect2Ddl("#ItemVariationDropDownList", '@EPMS.Web.Resources.Shared.Common.RequiredDdlField')) {
                getModalControlsValues();
            }
        });
        function getModalControlsValues() {
            //get item's values
            var isItemDescription = $('#ItemDescriptionModalChk').is(':checked');
            var isItemSku = $('#ItemSKUModalChk').is(':checked');
            var itemVariationId = $("#ItemVariationDropDownList").val();

            //set item's values
            var index = $("#ItemModalIndex").val();

            //set item sku and description in details text area
            var rfiItems = '@Html.Raw(Json.Encode(Model.ItemVariationDropDownList))';
            var parsedRfiItems = JSON.parse(rfiItems);

            $.each(parsedRfiItems, function (key, value) {
                if (value.ItemVariationId == itemVariationId) {
                    $("#Barcodes_" + index + "__ItemDetails").val("");
                    var textToAppend = "";
                    var barcodeValue;
                    if ('@direction' == "ltr") {
                        textToAppend = textToAppend + "Name: " + value.ItemNameE;
                    } else {
                        textToAppend = textToAppend + "Name: " + value.ItemNameA;
                    }
                    if (isItemSku) {
                        textToAppend = textToAppend + "\nSKU Code: " + value.SKUCode;
                    }
                    if (isItemDescription) {
                        if ('@direction' == "ltr") {
                            textToAppend = textToAppend + "\nDescription: " + value.ItemVariationDescriptionE;
                        } else {
                            textToAppend = textToAppend + "\nDescription: " + value.ItemVariationDescriptionA;
                        }
                    }
                    barcodeValue = value.ItemCodeSKUCode;
                    $("#Barcodes_" + index + "__ItemDetails").val(textToAppend);
                    $("#Barcodes_" + index + "__BarcodeValue").val(barcodeValue);
                }
            });
            generateBarcode(index);
            $('#itemSearcher').modal('toggle');
        }
        reActivatePrint();
        function reActivatePrint() {
            $(".print").unbind();
            $(".print").on('click', function (event) {
                //event.preventDefault();
                var index = $(this).parent().parent().get(0).rowIndex - 1;
                var validStatus = $("#Barcodes_" + index + "__ItemDetails").valid();
                if (validStatus) {
                    $("#BarcodeValue_" + index).show().printElement();
                }
            });
        }
    });
    $('#tiny').elrte({
        lang: "en",
        styleWithCSS: false,
        height: 200,
        toolbar: 'tiny'
    });
    function generateBarcode(index) {
        var barcodeValue = $("#Barcodes_" + index + "__BarcodeValue").val();
        barcodeValue = { code: barcodeValue, rect: true };
        var btype = "code128";
        var settings = {
            barWidth: 1,
            barHeight: 50,
            moduleSize: 5,
            showHRI: true,
            addQuietZone: true,
            marginHRI: 5,
            bgColor: "#FFFFFF",
            color: "#000000",
            fontSize: 10,
            output: "css",
            posX: 0,
            posY: 0
        };
        $("#BarcodeValue_" + index).barcode(barcodeValue, btype, settings);
    }
</script>