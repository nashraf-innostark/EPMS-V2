@model EPMS.Web.ViewModels.InventoryDepartment.InventoryDepartmentViewModel

@{
    var direction = EPMS.Web.Resources.Shared.Common.TextDirection;
    ViewBag.Title = EPMS.Web.Resources.Inventory.InventoryDepartment.PGTitleIndex;
    Layout = "~/Views/Shared/_Layout.cshtml";
    string[] userPermissionsSet = (string[])HttpContext.Current.Session["UserPermissionSet"];
    var i = 0;
    var k = 0;
}

<div class="main-content withPanel">
    <div class="panel">
        <div class="panel-content filler">
            <div class="panel-logo"></div>
            <div class="panel-header">
                <h1><small>@EPMS.Web.Resources.Inventory.InventoryDepartment.InventoryDepartmentsJSTreeTitle</small></h1>
                <button type="submit" class="btn btn-mini" onclick="deleteRow();">@EPMS.Web.Resources.Shared.Common.DeleteNode</button>
            </div>
            <div class="panel-search container-fluid">
                <form class="form-horizontal" action="javascript:;">
                    <input id="panelSearch" placeholder="Search" type="text" name="panelSearch">
                    <button class="btn btn-search"></button>
                </form>
            </div>
            <div class="sidebarMenuHolder">
                <div class="JStree">
                    <div class="Jstree_shadow_top"></div>
                    <div id="jstree"></div>
                    <div class="Jstree_shadow_bottom"></div>
                </div>
            </div>
        </div>
        <div class="panel-slider">
            <div class="panel-slider-center">
                <div class="panel-slider-arrow"></div>
            </div>
        </div>
    </div>
    <div class="breadcrumb-container">
        <ul class="xbreadcrumbs">
            <li>
                <a href="~/Dashboard/Index">
                    <i class="icon-photon home"></i>
                </a>
            </li>
            <li>
                @EPMS.Web.Resources.Inventory.InventoryDepartment.BCTitleIndex
            </li>
        </ul>
    </div>
    <header>
        <i class="icon-big-notepad"></i>
        <h2><small>@EPMS.Web.Resources.Inventory.InventoryDepartment.BCTitleIndex</small></h2>
    </header>
    @Html.Partial("_Alert")
    <form class="form-horizontal">
        <div class="container-fluid">
            <!--Tabs begin-->
            <div class="control-group row-fluid span-inset">
                <ul class="nav nav-tabs" id="myTab">
                    <li class="active"><a data-toggle="tab" href="#tab-Departments">@EPMS.Web.Resources.Inventory.InventoryDepartment.TabDepartments</a></li>
                    <li class=""><a data-toggle="tab" href="#tab-Sections">@EPMS.Web.Resources.Inventory.InventoryDepartment.TabSections</a></li>
                </ul>
                <div class="tab-content">
                    <div id="tab-Departments" class="tab-pane fade active in">
                        @if (userPermissionsSet.Contains("InventoryDepartmentCreate"))
                        {
                            <h3> <small><a href="~/Inventory/InventoryDepartment/Create">@EPMS.Web.Resources.Inventory.InventoryDepartment.AddNewDepartment</a></small></h3>
                        }
                        <div class="container-fluid">
                            <table class="table table-striped table-responsive" id="tableSortableDepartments">
                                <thead>
                                    <tr>
                                        <th class="center"> @EPMS.Web.Resources.Inventory.InventoryDepartment.DeptSerial</th>
                                        <th class="center"> @EPMS.Web.Resources.Inventory.InventoryDepartment.DeptName</th>
                                        <th class="center"> @EPMS.Web.Resources.Inventory.InventoryDepartment.DeptColor</th>
                                        <th class="center"> @EPMS.Web.Resources.Inventory.InventoryDepartment.DeptDescription</th>
                                        <th class="center"> @EPMS.Web.Resources.Inventory.InventoryDepartment.DeptNumberOfSections</th>
                                        <th class="center"> @EPMS.Web.Resources.Inventory.InventoryDepartment.DeptNumberOfSubSections</th>
                                        <th>@EPMS.Web.Resources.Inventory.InventoryItem.Delete</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var departments in Model.Departments)
                                    {
                                        var id = departments.DepartmentId + "_tableDepartment";
                                        <tr class="gradeX" id="@id">
                                            <td class="center">@(i += 1)</td>
                                            @if (direction == "ltr")
                                            {
                                                <td class="center"><a href="~/Inventory/InventoryDepartment/Create/@departments.DepartmentId">@departments.DepartmentNameEn</a></td>
                                            }
                                            else
                                            {
                                                <td class="center"><a href="~/Inventory/InventoryDepartment/Create/@departments.DepartmentId">@departments.DepartmentNameAr</a></td>
                                            }
                                            <td class="center">@departments.DepartmentColor</td>
                                            <td class="center @departments.DepartmentId"></td>
                                            <script>
                                                var descpE = '@Html.Raw(departments.DepartmentDesc)';
                                                var regex = /(<([^>]+)>)/ig;
                                                var result = descpE.replace(regex, "");
                                                $("." + '@departments.DepartmentId').text(result);
                                            </script>
                                            <td class="center">@departments.NoOfSections</td>
                                            <td class="center">-</td>
                                            <td class="@departments.DepartmentId"><a href="#" id="delete" onclick="deleteRow()">@EPMS.Web.Resources.Inventory.InventoryItem.Delete</a></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="tab-Sections" class="tab-pane fade">
                        @if (userPermissionsSet.Contains("InventorySectionCreate"))
                        {
                            <h3> <small><a href="~/Inventory/InventoryDepartment/Section">@EPMS.Web.Resources.Inventory.InventoryDepartment.AddNewSection</a></small></h3>
                        }
                        <div class="container-fluid">
                            <div class="row-fluid">
                                <div class="span12">
                                    <table class="table table-striped table-responsive" id="tableSortableSections">
                                        <thead>
                                            <tr>
                                                <th class="center"> @EPMS.Web.Resources.Inventory.InventoryDepartment.DeptSerial</th>
                                                <th class="center">@EPMS.Web.Resources.Inventory.InventoryDepartment.SectParentDepartment</th>
                                                <th class="center">@EPMS.Web.Resources.Inventory.InventoryDepartment.SectParentSection</th>
                                                <th class="center">@EPMS.Web.Resources.Inventory.InventoryDepartment.SectName</th>
                                                <th class="center">@EPMS.Web.Resources.Inventory.InventoryDepartment.SectDescription</th>
                                                <th class="center">@EPMS.Web.Resources.Inventory.InventoryDepartment.NumberOfSubSections</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var departments in Model.Sections.OrderBy(x => x.DepartmentNameEn))
                                            {
                                                var id = departments.DepartmentId + "_tableSection";
                                                <tr class="gradeX" id="@id">
                                                    <td class="center">@(k += 1)</td>
                                                    @if (direction == "ltr")
                                                    {
                                                        <td class="center">@departments.ParentDepartmentEn</td>
                                                    }
                                                    else
                                                    {
                                                        <td class="center">@departments.ParentDepartmentAr</td>
                                                    }
                                                    <td class="center">
                                                        @for (int j = departments.ParentNodesSections.Count - 1; j >= 0; j--)
                                                        {
                                                            var parentNodesSection = departments.ParentNodesSections[j];
                                                            if (parentNodesSection.TextEn != "None")
                                                            {
                                                                <a href="~/Inventory/InventoryDepartment/Create/@parentNodesSection.Href">@parentNodesSection.TextEn</a>
                                                                @: >
                                                            }
                                                            else
                                                            {
                                                                @:None
                                                            }
                                                        }
                                                    </td>
                                                    @if (direction == "ltr")
                                                    {
                                                        <td class="center"><a href="~/Inventory/InventoryDepartment/Create/@departments.DepartmentId">@departments.DepartmentNameEn</a></td>
                                                    }
                                                    else
                                                    {
                                                        <td class="center"><a href="~/Inventory/InventoryDepartment/Create/@departments.DepartmentId">@departments.DepartmentNameAr</a></td>
                                                    }
                                                    <td class="@departments.DepartmentId"></td>
                                                    <script>
                                                        var descpE = '@Html.Raw(departments.DepartmentDesc)';
                                                        var regex = /(<([^>]+)>)/ig;
                                                        var result = descpE.replace(regex, "");
                                                        $("." + '@departments.DepartmentId').text(result);
                                                    </script>
                                                    <td class="center">@departments.NoOfSections</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div><!-- end container -->
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script type="text/javascript">
    var dataTable;
    var dir = '@direction';
    var inventoryDepartments = '@Html.Raw(Json.Encode(Model.InventoryDepartments))';
    var parsed = JSON.parse(inventoryDepartments);
    var inventorySections = '@Html.Raw(Json.Encode(Model.Sections))';
    var parsedSection = JSON.parse(inventorySections);
    $(document).ready(function() {
        $("#layoutMainContent").removeClass("main-content");
        $('#tableSortableDepartments').dataTable({
            "sPaginationType": "bootstrap",
            "fnInitComplete": function() {
                $(".dataTables_wrapper select").select2({
                    dropdownCssClass: 'noSearch'
                });
            },
            "fnDrawCallback": function(oSettings) {
                subItemsOfDepartments();
            }
        });
        $('#tableSortableSections').dataTable({
            "sPaginationType": "bootstrap",
            "aoColumns": [
                null,
                null,
                null,
                null,
                null,
                null
            ],
            "fnInitComplete": function() {
                $(".dataTables_wrapper select").select2({
                    dropdownCssClass: 'noSearch'
                });
            },
            "fnDrawCallback": function(oSettings) {
                subItemsOfSections();
            }
        });
        if (dir == "ltr") {
            myTree = $("#jstree").jstree({
                "json_data": {
                    "data": [
                        {
                            "data": {
                                "title": "Departments",
                                "attr": { "href": "#", "onclick": "jsTreeClick(event)" }
                            },
                            "attr": { "id": "parentNode" },
                        }
                    ]
                },
                "plugins": ["themes", "json_data", "ui"],
                "ui": {
                    "initially_select": ["parentNode"]
                },
                "core": {
                    "initially_open": ["parentNode"]
                }
            });
        } else {
            myTree = $("#jstree").jstree({
                "json_data": {
                    "data": [
                        {
                            "data": {
                                "title": "القسم",
                                "attr": { "href": "#", "onclick": "" }
                            },
                            "attr": { "id": "parentNode" },
                        }
                    ]
                },
                "plugins": ["themes", "json_data", "ui"],
                "ui": {
                    "initially_select": ["parentNode"]
                },
                "core": {
                    "initially_open": ["parentNode"]
                }
            });
        }
        var position = 'last';
        var parentNode;
        var mainParent;
        var newNode;
        setTimeout(function() {
            $.each(parsed, function(key, value) {
                if (value.ParentId != null) {
                    $('ul li').each(function() {
                        if ($(this).attr('id') == value.ParentId) {
                            parentNode = this;
                        }
                    });
                    if (dir == "ltr") {
                        newNode = {
                            state: "closed",
                            data: {
                                "title": value.DepartmentNameEn,
                                "attr": { "href": "#", "onclick": "jsTreeClick(event)" }
                            },
                            "attr": { "id": value.DepartmentId },
                        };
                    } else {
                        newNode = {
                            state: "closed",
                            data: {
                                "title": value.DepartmentNameAr,
                                "attr": { "href": "#", "onclick": "jsTreeClick(event)" }
                            },
                            "attr": { "id": value.DepartmentId },
                        };
                    }
                    var elem1 = $('#jstree').jstree("create_node", parentNode, position, newNode, false, false);
                    //if (value.MenuType == "Content") {
                    //    elem1.addClass("jstree-leaf");
                    //}
                } else {
                    mainParent = $('#jstree').jstree('get_selected');
                    if (dir == "ltr") {
                        newNode = {
                            state: "closed",
                            data: {
                                "title": value.DepartmentNameEn,
                                "attr": { "href": "#", "onclick": "jsTreeClick(event)" }
                            },
                            "attr": { "id": value.DepartmentId },
                        };
                    } else {
                        newNode = {
                            state: "closed",
                            data: {
                                "title": value.DepartmentNameAr,
                                "attr": { "href": "#", "onclick": "jsTreeClick(event)" }
                            },
                            "attr": { "id": value.DepartmentId },
                        };
                    }
                    $('#jstree').jstree("create_node", mainParent, position, newNode, false, false);
                }
            });
            $('#jstree').jstree('open_node', '#parentNode');
            $('.panel, .main-content').toggleClass('retracted');
        }, 0);
        setTimeout(function() {
            subItemsOfSections();
            subItemsOfDepartments();
        }, 1);
        //$(".dataTables_paginate").on("click", "a", function () { alert("clicked"); });
    });

    function subItemsOfSections() {
        $.each(parsedSection, function(key, value) {
            var deptId = value.DepartmentId;
            var parent = $('#jstree').find("[id='" + deptId + "']");
            var childs = $(parent).find("li").length;
            $("#" + deptId + "_tableDepartment td:eq( 4 )").text(childs);
        });
    }

    function subItemsOfDepartments() {
        $.each(parsed, function(key, value) {
            var deptId = value.DepartmentId;
            var parent = $('#jstree').find("[id='" + deptId + "']");
            var childs = $(parent).find("li").length;
            $("#" + deptId + "_tableDepartment td:eq( 5 )").text(childs);
        });
    }

    function deleteRow() {
        if (confirm("Are you sure you want to delete this row ?") == false) {
            return;
        }

        debugger;
        if (parseInt($("#Warehouse_WarehouseId").val()) == 0) {
            return false;
        }
        var parentId = $('#jstree').jstree('get_selected').attr('id');

        var serviceUrl = '/Inventory/InventoryDepartment/Delete';
        $.ajax({
            url: serviceUrl,
            type: "POST",
            dataType: "json",
            data: {
                departmentId: parentId
            },
            success: function(data) {
                if (data == "Deleted") {
                    $.pnotify({
                        title: 'Success',
                        type: 'success',
                        text: 'Record has been Deleted.'
                    });
                    //var row = $("." + departmentId).parent().get(0);
                    //var atable = $('#tableSortableDepartments').dataTable();
                    //var pos = atable.fnGetPosition(row);
                    //atable.fnDeleteRow(pos);
                    location.reload();
                } else if (data == "AssociatedDepartments") {
                    $.pnotify({
                        title: 'Failure',
                        type: 'error',
                        text: 'Cannot delete, sections exist.'
                    });
                } else {
                    $.pnotify({
                        title: 'Failure',
                        type: 'error',
                        text: 'Cannot delete, inventory items exist.'
                    });
                }

            },
        });
    }

    function jsTreeClick(event) {
        return true;
    }

</script>
