@model EPMS.Web.ViewModels.IRF.ItemReleaseFormCreateViewModel

@{
    var direction = EPMS.Web.Resources.Shared.Common.TextDirection;
    string[] userPermissionsSet = (string[])HttpContext.Current.Session["UserPermissionSet"];
    string[] userModules = (string[])HttpContext.Current.Session["UserModules"];
    ViewBag.Title = EPMS.Web.Resources.Inventory.IRFCreate.PageTitle;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="breadcrumb-container">
    <ul class="xbreadcrumbs">
        <li>
            <a href="~/Dashboard/Index">
                <i class="icon-photon home"></i>
            </a>
        </li>
        <li>
            <a href="~/Inventory/ItemReleaseForm/Index">
                @EPMS.Web.Resources.Inventory.IRFIndex.Header
            </a>
        </li>
        <li class="current">
            <a href="javascript:;">
                @ViewBag.Title
            </a>
        </li>
    </ul>
</div>

<header>
    <i class="icon-big-notepad"></i>
    <h2><small>@EPMS.Web.Resources.Inventory.IRFCreate.Header</small></h2>
</header>
<!--Notifications begin-->
@Html.Partial("_Alert")
<!--Notifications end-->
@using (Html.BeginForm("Create", "ItemReleaseForm", FormMethod.Post, new { @class = "form-horizontal", @id = "AddEditItemReleaseForm", role = "form", enctype = "multipart/form-data" }))
{
    <div class="container-fluid">
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="greeting">Item Release From (IRF) Number </label>
            </div>
            <div class="span9">
                <div class="controls">
                    <input id="greeting" type="text" value="1010202015" readonly="true">
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="MaritalStatus">Requester </label>
            </div>
            <div class="span2">
                <div class="controls">
                    @if (direction == "ltr")
                    {
                        @Html.DropDownList("En", new SelectList(Model.Customers, "CustomerId", "CustomerNameE"), "--Select--", new { @class = "select2me", @id = "Requester" })
                    }
                    else
                    {
                        @Html.DropDownList("Ar", new SelectList(Model.Customers, "CustomerId", "CustomerNameA"), "--Select--", new { @class = "select2me", @id = "Requester" })
                    }
                </div>
            </div>

        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="MaritalStatus">RFI# </label>
            </div>
            <div class="span2">
                <div class="controls">
                    @if (direction == "ltr")
                    {
                        @Html.DropDownList("En", new SelectList(Model.Rfis, "RFIId", "RFIId"), "--Select--", new { @class = "select2me", @id = "RfiId" })
                    }
                    else
                    {
                        @Html.DropDownList("Ar", new SelectList(Model.Rfis, "RFIId", "RFIId"), "--Select--", new { @class = "select2me", @id = "RfiId" })
                    }
                </div>
            </div>

        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="greeting">Order #</label>
            </div>
            <div class="span9">
                <div class="controls">
                    <input id="orderNumber" type="text" value="" readonly="true">
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="createdBy">Created By  </label>
            </div>
            <div class="span9">
                <div class="controls">
                    <input id="createdBy" type="text" disabled value="">
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="createdBy">Delivery Information  </label>
            </div>
            <div class="span9">
                <div class="controls">
                    <input type="text" disabled value="CK Editor - taken from customer information">
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3">
                <label class="control-label" for="createdBy">Delivery Information arabic </label>
            </div>
            <div class="span9">
                <div class="controls">
                    <input type="text" disabled value="CK Editor - taken from customer information">
                </div>
            </div>
        </div>
        <div id="WYSIWYG_Editor_-_Minimum_Options" class="control-group row-fluid">
            <div class="span3">
                <label class="control-label">Excel Import</label>
            </div>
            <div class="span9">
                <div class="controls elrte-wrapper">
                    <textarea id="tiny" rows="2" class="auto-resize"></textarea>
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3 span-inset">
                <button type="button" id="importEx" class="btn">Import</button>
            </div>
            <div class="span3 span-inset">
                <button type="button" id="itemFromOrder" class="btn">Import Items From Order</button>
            </div>
        </div>
        <div class="row-fluid" id="ress">
            <div class="span12">
                <table class="table table-striped table-responsive ">
                    <thead class="">
                        <tr>
                            <th>Serial</th>
                            <th style="width:50%">Item Details</th>
                            <th>Warhouse</th>
                            <th>Quantity</th>
                            <th style="width:4%">Delete</th>
                        </tr>
                    </thead>
                    <tbody class="qouteAdd">
                        <tr>
                            <td>
                                <div class="control-group row-fluid">
                                    <div class="span1">
                                        <label class="control-label serialNumber">1</label>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <textarea rows="2" class="auto-resize">item name - item sku - item description</textarea><button type="button" class="btn itemAdder" data-toggle="modal" data-target="#itemSearcher">+</button>
                            </td>
                            <td>
                                <textarea rows="2" class="auto-resize">War101 > Aisle 1 > Section 1 > Shalf 2 > Section on Shalf 5 - War102 > Aisle 10 > Section 5 > Shalf 3 > Section on Shalf 5 </textarea>
                                <button type="button" class="btn itemAdder" data-toggle="modal" data-target="#warhouseSelector">+</button>
                            </td>
                            <td class="quantity">
                                <input class="n1" type="text" name="numbers" value="0">
                            </td>
                            <td class="delete">
                                <i class="icon-photon minus deleteRow"></i>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="control-group row-fluid">
                <div class="span3 span-inset">
                    <button type="button" class="btn trAdder">Add</button>
                </div>
            </div>
        </div>
        <div class="control-group row-fluid">
            <div class="span3 span-inset">
                <button type="button" class="btn">Submit</button>
            </div>
        </div>
    </div>
}

@section popups
{
    @Html.Partial("_IRFItemsPopUp")
    @*@Html.Partial("_ItemsPopUp")*@
    @Html.Partial("_IRFWarehousePopUp")
}

<script>
    var siteUrl;
    var orderNo = [];
    $(document).ready(function () {
        siteUrl = $("#siteURL").val();
        $('.trAdder').on("click", function () {
            var html = ' <tr>  <td ><div class="control-group row-fluid"><div class="span1"><label class="control-label serialNumber"  ></label></div></div></td>  <td > <textarea  rows="2" class="auto-resize"></textarea><button type="button" class="btn itemAdder" data-toggle="modal" data-target="#itemSearcher" >+</button></td> <td >  <textarea  rows="2" class="auto-resize" > </textarea><button type="button" class="btn itemAdder" data-toggle="modal" data-target="#warhouseSelector" >+</button>	</td><td class="quantity"> <input class="n1" type="text" name="numbers" value=0> </td>  <td class="delete"> <i class="icon-photon minus deleteRow"></i> </td></tr>'
            $('.qouteAdd').append(html);
            activateSerial();
            reActivateDelete();
            //reactivateCount();
        });
        reActivateDelete();
        //reactivateCount();

        /*
        function reactivateCount(){

            $('.quantity .n1').on("blur",function(){

                var n2Val = $(this).parent().parent().find(".n2").val();

                    $(this).parent().parent().find(".n3").val($(this).val()* n2Val);
                    var x = 0;
                $('.qouteAdd tr .n3').each(function(){

                     x  = x + parseInt($(this).val());

                });
                    $('#subtotal').val(x);
                    discount();

         });
         $('.unitPrice .n2').on("blur",function(){

                var n2Va2 = $(this).parent().parent().find(".n1").val();

                    $(this).parent().parent().find(".n3").val($(this).val()* n2Va2);
                    var x = 0;
                $('.qouteAdd tr .n3').each(function(){

                     x  = x + parseInt($(this).val());

                });
                    $('#subtotal').val(x);
                    discount();

         });
        }


        $('#Discount').on("blur",function(){
            discount();

        });

        function discount(){
            var subtotal =	parseInt($('#subtotal').val()) ;
                    var Discount =	parseInt($('#Discount').val()) ;
                    var grand = subtotal-(subtotal *(Discount/100))
                        $('#GrandTotal').val(grand);
        }

        */
        $("#importEx").on("click", function () {
            var excel = $("#WYSIWYG_Editor_-_Minimum_Options iframe").contents().find("body table");
            var coln = $(excel).find("tr:first td").length;
            var count = 0;
            var x = 0;
            if (coln == 3) {
                $(excel).find("tr").each(function () {
                    var y = 0;
                    var t1 = "";
                    var t2 = 0;
                    var t3 = 0;
                    var t4 = 0;
                    $(this).find("td").each(function () {
                        if (y == 0) {
                            t1 = $(this).text();
                        }
                        else if (y == 1) {
                            t2 = $(this).text();
                        }
                        else if (y == 2) {
                            t3 = parseInt($(this).text());
                        }
                        y++;
                    });
                    t4 = t3 * t2;
                    var html = ' <tr> <td ><div class="control-group row-fluid"><div class="span1"><label class="control-label serialNumber"></label></div></div></td><td > <textarea rows="2" class="auto-resize" >' + t1 + '</textarea><button type="button" class="btn itemAdder" data-toggle="modal" data-target="#itemSearcher" >+</button></td> <td >  <textarea  rows="2" class="auto-resize" > ' + t2 + '</textarea><button type="button" class="btn itemAdder" data-toggle="modal" data-target="#warhouseSelector" >+</button>	</td> <td class="quantity"> <input class="n1" type="text" name="numbers" value="' + t3 + '"> </td> <td class="delete"> <i class="icon-photon minus deleteRow"></i> </td></tr>'
                    if (count == 0) {
                        $('.qouteAdd').html("");
                    }
                    $('.qouteAdd').append(html);
                    reActivateDelete();
                    //reactivateCount();
                    count++;
                });
                /*
                        $('.qouteAdd tr .n3').each(function(){

                            x  = x + parseInt($(this).val());

                        });
                        $('#subtotal').val(x);
                        */
                activateSerial();
            }
            else {
                $.pnotify({
                    title: 'Sorry',
                    type: 'info',
                    text: 'The sheet you are trying to import is not supported, please check if the feilds match.'
                });
            }
        });
        /*
        $('.installer').on("blur",function(){
            b = 0;


                b =  parseInt($('#Installment1').val());
                if(b>100){
                 noteIt();
                 $(this).val(0);
                 return;
                }
                else
                {
                  b = b + parseInt($('#Installment2').val());
                     if(b>100){
                     noteIt();
                     $(this).val(0);
                     return;
                    }
                    else{
                        b =	b+  parseInt($('#Installment3').val());
                                if(b>100){
                         noteIt();
                         $(this).val(0);
                         return;
                        }
                        else{
                         b = b+  parseInt($('#Installment4').val());
                         if(b>100){
                         noteIt();
                         $(this).val(0);
                         return;
                        }
                        }
                    }
                }
            function noteIt(){
            $.pnotify({
                            title: 'Sorry',
                            type: 'info',
                            text: 'The total % of all the due to project should not exceed 100'
                        });

                        $(this).val(0);
                        }
        });
        $('.dap').on("blur",function(){
            bb = 0;


                bb =  parseInt($('#Dueat').val());
                if(bb>100){
                 noteItb();
                 $(this).val(0);
                 return;
                }
                else
                {
                  bb = bb + parseInt($('#Dueat2').val());
                     if(bb>100){
                     noteItb();
                     $(this).val(0);
                     return;
                    }
                    else{
                        bb =	bb+  parseInt($('#Dueat3').val());
                                if(bb>100){
                         noteItb();
                         $(this).val(0);
                         return;
                        }
                        else{
                         bb = bb+  parseInt($('#Dueat4').val());
                         if(bb>100){
                         noteItb();
                         $(this).val(0);
                         return;
                        }
                        }
                    }
                }
            function noteItb(){
            $.pnotify({
                            title: 'Sorry',
                            type: 'info',
                            text: 'The total % of all the installments should not exceed 100'
                        });

                        $(this).val(0);
                        }

        });

        */
        $("#selectBoxFilter").select2();
        $("#Requester").on("change", function () {
            var customerId = parseInt($(this).val());
            if (isNaN(customerId)) {
                customerId = 0;
            }
            if (customerId == 0) {
                $("#RfiId").empty();
                $("#RfiId").append(
                        $('<option></option>').val(0).html("none")
                    );
                $(".select2me").select2("destroy");
                $('.select2me').select2({
                    //placeholder: "Select",
                });
                return true;
            }
            var url = siteUrl + "/Inventory/ItemReleaseForm/GetCustomerRfis";
            ajaxLoader();
            $.ajax({
                url: url,
                type: 'GET',
                dataType: "json",
                data: {
                    customerId: customerId
                },
                success: function (data) {
                    populateRFIDDL(data);
                },
                error: function (e) {
                    $.unblockUI();
                    alert('Error=' + e.toString());
                }
            });
        });
        $("#RfiId").on("change", function () {
            $.each(orderNo, function(key, value) {
                if (value.rfiId == parseInt($("#RfiId").val())) {
                    $("#orderNumber").val(value.orderNo);
                }
            });
        });
    });
    $('#tiny').elrte({
        lang: "en",
        styleWithCSS: false,
        height: 200,
        toolbar: 'tiny'
    });
    function reActivateDelete() {
        $('.deleteRow').on("click", function () {
            var count = $('.qouteAdd tr').length;
            if (count > 1) {
                $(this).parent().parent().remove();
                /*
                        var x = 0;
                $('.qouteAdd tr .n3').each(function(){

                     x  = x + parseInt($(this).val());

                });
                    $('#subtotal').val(x);
                    discount();
                    */
            }
            activateSerial();
        });
    }
    function activateSerial() {
        var count = $('.qouteAdd tr').length;
        var add = 0;
        $('.qouteAdd tr').each(function () {
            add++;
            $(this).find(".serialNumber").text(add);

        });
    }
    function populateRFIDDL(data) {
        $("#RfiId").empty();
        if (data.length > 0) {
            orderNo = [];
            $("#RfiId").append(
                $('<option></option>').val(0).html("--Select--")
            );
            for (var i = 0; i < data.length; i++) {
                $("#RfiId").append(
                    $('<option></option>').val(data[i].RFIId).html(data[i].RFIId)
                );
                var order = {
                    rfiId: data[i].RFIId,
                    orderNo: data[i].OrderNumber
                };
                orderNo.push(order);
            }
        } else {
            $("#RfiId").append(
                $('<option></option>').val(0).html("none")
            );
        }
        $(".select2me").select2("destroy");
        $('.select2me').select2({
            //placeholder: "Select",
        });
        $.unblockUI();
    }
</script>